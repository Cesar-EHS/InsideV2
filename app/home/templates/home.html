{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-white">
  <!-- Saludo personalizado -->
  <section class="px-6 pt-8 pb-6">
    <h1 id="saludo" data-nombre="{{ usuario.nombre }}" class="text-3xl font-semibold text-gray-900 tracking-tight font-sfpro"></h1>
  </section>

  <!-- Layout para m√≥vil: eventos arriba horizontal, publicaciones abajo -->
  <div class="lg:hidden">
    <!-- Eventos horizontales en m√≥vil -->
    <div class="px-6 mb-3">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-medium text-gray-900">Pr√≥ximos eventos</h2>
        {% if current_user.rol == 'admin' or current_user.is_admin %}
        <button id="btn-nuevo-evento-mobile" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Agregar
        </button>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        <div class="flex gap-4 pb-2" style="width: max-content;">
          {% for evento in eventos[:5] %}
          <div class="w-64 bg-white rounded-xl shadow-sm p-4 border border-gray-100 flex-shrink-0 group relative">
            <!-- Men√∫ de 3 puntos para eventos m√≥viles -->
            {% if current_user.rol == 'admin' or current_user.is_admin %}
            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <div class="relative dropdown">
                <button class="dropdown-toggle" data-dropdown-id="evento-mobile-{{ evento.id }}" type="button" aria-label="Opciones de evento">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                  </svg>
                </button>
                <div id="dropdown-evento-mobile-{{ evento.id }}" class="dropdown-menu">
                  <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_evento', id=evento.id) }}" data-delete-type="evento" type="button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
            {% endif %}
            
            <h3 class="font-medium text-gray-900 mb-2 line-clamp-2">{{ evento.titulo }}</h3>
            <div class="flex items-center gap-3 text-sm text-gray-600 mb-2">
              <span>{{ evento.fecha.strftime('%d/%m') }}</span>
              {% if evento.hora %}
              <span>{{ evento.hora.strftime('%H:%M') }}</span>
              {% endif %}
            </div>
            <p class="text-sm text-gray-600 line-clamp-3 mb-3">{{ evento.descripcion or 'Sin descripci√≥n' }}</p>
            {% if evento.link_teams %}
            <a href="{{ evento.link_teams }}" target="_blank" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 text-sm font-medium">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0189 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0189 1.3332-.946 2.4189-2.1569 2.4189Z"/>
              </svg>
              Unirse
            </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Layout para desktop -->
  <div class="flex flex-col lg:flex-row lg:px-6 lg:gap-8 lg:items-start">
    <!-- Publicaciones - 2/3 en desktop -->
    <main class="lg:w-2/3 px-6 lg:px-0">
      <!-- Nueva publicaci√≥n integrada con filtros -->
      {% if current_user.rol == 'admin' or current_user.is_admin %}
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
        <!-- Crear publicaci√≥n -->
        <div class="flex items-center gap-4 mb-4">
          <img src="{{ usuario.foto_url }}" alt="Foto de {{ usuario.nombre }}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null; this.src='/static/default_user.png';">
          <button id="btn-abrir-modal-post" class="bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full px-4 py-3 w-full text-left focus:outline-none focus:ring-2 focus:ring-blue-200 transition font-medium text-sm" aria-label="¬øListo para publicar?" type="button">
            ¬øListo para publicar, {{ usuario.nombre.split(' ')[0] }}?
          </button>
        </div>
        
        <!-- Filtros integrados -->
        <div x-data="{ open: false }" class="border-t border-gray-100 pt-4">
          <button type="button" @click="open = !open" class="flex items-center gap-2 text-gray-600 hover:text-blue-600 text-sm px-3 py-2 rounded-lg hover:bg-blue-50 transition-all focus:outline-none focus:ring-2 focus:ring-blue-200" aria-expanded="false" aria-controls="filtros-form">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-6.414 6.414A1 1 0 0013 13.414V19a1 1 0 01-1.447.894l-2-1A1 1 0 009 18v-4.586a1 1 0 00-.293-.707L2.293 6.707A1 1 0 012 6V4z"/></svg>
            Filtrar publicaciones
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" :class="open ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <form id="filtros-form" x-show="open" x-transition.opacity x-transition.duration.250ms method="GET" action="{{ url_for('home.home') }}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200" style="display: none;" @click.away="open = false">
            <div class="flex flex-col gap-1">
              <label class="text-xs font-medium text-gray-700">A√±o</label>
              <select name="filter_year" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <option value="">Todos los a√±os</option>
                {% for year in a√±os_posts %}
                  <option value="{{ year }}" {% if filter_year == year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-xs font-medium text-gray-700">Mes</label>
              <select name="filter_month" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <option value="">Todos los meses</option>
                {% for month in meses %}
                  <option value="{{ month }}" {% if filter_month == month %}selected{% endif %}>{{ month }}</option>
                {% endfor %}
              </select>
            </div>
            {% if current_user.rol == 'admin' or current_user.is_admin %}
            <div class="flex flex-col gap-1">
              <label class="text-xs font-medium text-gray-700">Proyecto</label>
              <select name="filter_proyecto" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <option value="">Todos los proyectos</option>
                <option value="publicos" {% if filter_proyecto == 'publicos' %}selected{% endif %}>‚óã Solo p√∫blicos</option>
                {% for proyecto in proyectos %}
                  <option value="{{ proyecto.id }}" {% if filter_proyecto|string == proyecto.id|string %}selected{% endif %}>‚óê {{ proyecto.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            {% endif %}
            <div class="flex flex-col gap-1">
              <label class="text-xs font-medium text-gray-700">Autor</label>
              <select name="filter_user" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <option value="">Todos los autores</option>
                {% for user in usuarios %}
                  <option value="{{ user.id }}" {% if filter_user|int == user.id %}selected{% endif %}>{{ user.nombre }} {{ user.apellido_paterno }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="md:col-span-2 lg:col-span-4 flex justify-end">
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition-colors text-sm">Aplicar filtros</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}
      
      <!-- Publicaciones flotantes -->
      {% if posts %}
      <div class="space-y-6">
        {% for post in posts %}
        <article class="bg-white rounded-xl shadow-sm p-6 group relative">
          {% if (post.user_id == current_user.id or current_user.is_admin) and (current_user.rol == 'admin' or current_user.is_admin) %}
          <!-- Men√∫ de 3 puntos para publicaciones -->
          <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
            <div class="relative dropdown">
              <button class="dropdown-toggle" data-dropdown-id="post-{{ post.id }}" type="button" aria-label="Opciones de publicaci√≥n">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                </svg>
              </button>
              <div id="dropdown-post-{{ post.id }}" class="dropdown-menu">
                <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_post', post_id=post.id) }}" data-delete-type="publicacion" type="button">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                  Eliminar
                </button>
              </div>
            </div>
          </div>
          {% endif %}
          
          <div class="mb-4">
            <div class="flex items-center gap-3 mb-3">
              <img src="{{ post.user.foto_url }}" alt="Foto de {{ post.user.nombre }} {{ post.user.apellido_paterno }}" class="w-12 h-12 rounded-full object-cover">
              <div class="flex-1">
                <h2 class="text-gray-900 font-medium text-base">{{ post.user.nombre }} {{ post.user.apellido_paterno }}</h2>
                <div class="flex items-center gap-2">
                  <time class="text-gray-500 text-sm">{{ post.timestamp.strftime('%d/%m/%Y %H:%M') }}</time>
                  <!-- Icono de visibilidad mejorado -->
                  {% if post.visible_para_todos %}
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Visible para todos los proyectos">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-xs text-gray-500 bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">P√∫blico</span>
                  </div>
                  {% elif post.proyectos_nombres %}
                  <div class="relative group flex items-center gap-1">
                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Visible solo para proyectos espec√≠ficos">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <span class="text-xs text-gray-500 bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-medium">Privado</span>
                    <!-- Tooltip mejorado -->
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-200 whitespace-nowrap z-20 shadow-lg">
                      <div class="font-medium mb-1">Visible para:</div>
                      <div class="text-gray-300">{{ post.proyectos_nombres|join(', ') }}</div>
                      <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            <p class="text-gray-800 text-base leading-relaxed mb-4">{{ post.content }}</p>
          </div>
          
          {% if post.image_filename %}
          <div class="mb-4">
            <img src="{{ url_for('home.static', filename='uploads/' + post.image_filename) }}" alt="Imagen adjunta" class="w-full rounded-lg object-contain max-h-96 bg-gray-50">
          </div>
          {% endif %}
          
          <div class="flex items-center gap-6 text-gray-600 text-sm mb-4">
            {% set user_love = post.reactions|selectattr("user_id", "equalto", current_user.id)|selectattr("type", "equalto", "love")|list|length > 0 %}
            <button class="flex items-center gap-2 {% if user_love %}text-red-500{% else %}hover:text-red-500{% endif %} focus:outline-none transition" data-post-id="{{ post.id }}" data-reaction="love" type="button">
              <svg class="w-5 h-5" fill="{% if user_love %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
              <span class="font-medium hidden sm:inline">Me Gusta</span>
              <span id="love-count-{{ post.id }}" class="ml-1">{{ post.reactions|selectattr('type', 'equalto', 'love')|list|length }}</span>
            </button>
            <button id="btn-comments-toggle-{{ post.id }}" data-post-id="{{ post.id }}" class="flex items-center gap-2 hover:text-blue-600 transition" aria-expanded="false" aria-controls="comments-section-{{ post.id }}" type="button">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10m0 0V6a2 2 0 00-2-2H9a2 2 0 00-2 2v2m10 0v8a2 2 0 01-2 2H9a2 2 0 01-2-2v-8m10 0H7m6 4h.01"/>
              </svg>
              <span class="font-medium hidden sm:inline">Comentar</span>
              <span class="ml-1">{{ post.comments.count() }}</span>
            </button>
          </div>
          
          <section id="comments-section-{{ post.id }}" class="hidden space-y-3" aria-live="polite" tabindex="0">
            <ul class="space-y-3" id="comentarios-lista-{{ post.id }}">
              {% set comentarios = post.comments|sort(attribute='timestamp', reverse=True) %}
              {% for comment in comentarios[:5] %}
              <li class="flex space-x-3 group relative" data-comment-id="{{ comment.id }}">
                <!-- Men√∫ de 3 puntos para comentarios (lado derecho) -->
                {% if (comment.user_id == current_user.id or current_user.is_admin) %}
                <div class="absolute right-0 top-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                  <div class="relative dropdown">
                    <button class="dropdown-toggle" data-dropdown-id="comment-{{ comment.id }}" type="button" aria-label="Opciones de comentario">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                      </svg>
                    </button>
                    <div id="dropdown-comment-{{ comment.id }}" class="dropdown-menu">
                      <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_comment', comment_id=comment.id) }}" data-delete-type="comentario" type="button">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Eliminar
                      </button>
                    </div>
                  </div>
                </div>
                {% endif %}
                <img title="{{ comment.user.nombre }} {{ comment.user.apellido_paterno }}" class="w-8 h-8 rounded-full flex-shrink-0" src="{{ comment.user.foto_url if comment.user.foto_url else url_for('auth.static', filename='img/default_user.png') }}" alt="Avatar">
                <div class="flex-1 bg-gray-100 rounded-xl px-3 py-2">
                  <p class="text-gray-800 text-sm">{{ comment.content }}</p>
                </div>
              </li>
              {% endfor %}
            </ul>
            
            <!-- Bot√≥n "Ver m√°s comentarios" -->
            {% if post.comments.count() > 5 %}
            {% set remaining_comments = post.comments.count() - 5 %}
            <button id="load-more-{{ post.id }}" 
                    class="mostrar-mas-comentarios text-sm font-medium hover:underline cursor-pointer"
                    style="color: #3c3c3b;"
                    data-post-id="{{ post.id }}"
                    data-page="1">
              Ver m√°s comentarios ({{ remaining_comments }} restante{% if remaining_comments != 1 %}s{% endif %})
            </button>
            {% endif %}
            
            <form method="POST" action="{{ url_for('home.add_comment', post_id=post.id) }}" class="flex gap-2 mt-3 comment-form" novalidate>
              {{ form_post.csrf_token }}
              <textarea name="comment_content" rows="1" required placeholder="Escribe un comentario..." class="flex-1 border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-blue-500 text-sm resize-none placeholder-gray-400"></textarea>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg transition-colors text-sm">Enviar</button>
            </form>
          </section>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-center text-gray-500 italic mt-6">No hay publicaciones disponibles.</p>
      {% endif %}
    </main>

    <!-- Sidebar de eventos - 1/3 en desktop -->
    <aside class="lg:w-1/3 hidden lg:block lg:mt-0 mt-6" role="complementary">
      <div class="lg:sticky lg:top-6 space-y-6">
        <!-- Header con bot√≥n agregar evento -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-medium text-gray-900">Pr√≥ximos eventos</h2>
            {% if current_user.rol == 'admin' or current_user.is_admin %}
            <button id="btn-nuevo-evento" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Agregar
            </button>
            {% endif %}
          </div>

          <!-- Lista de eventos (m√°ximo 5) -->
          {% if eventos %}
          <div class="space-y-4">
            {% for evento in eventos[:5] %}
            <div class="border border-gray-100 rounded-xl p-4 group relative hover:shadow-sm transition-shadow">
              <!-- Men√∫ de 3 puntos para eventos -->
              {% if current_user.rol == 'admin' or current_user.is_admin %}
              <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                <div class="relative dropdown">
                  <button class="dropdown-toggle" data-dropdown-id="evento-{{ evento.id }}" type="button" aria-label="Opciones de evento">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                    </svg>
                  </button>
                  <div id="dropdown-evento-{{ evento.id }}" class="dropdown-menu">
                    <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_evento', id=evento.id) }}" data-delete-type="evento" type="button">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>
              {% endif %}
              
              <h3 class="font-medium text-gray-900 mb-2 line-clamp-2 pr-6">{{ evento.titulo }}</h3>
              <div class="flex items-center gap-3 text-sm text-gray-600 mb-2">
                <span class="font-medium">{{ evento.fecha.strftime('%d de %B') }}</span>
                {% if evento.hora %}
                <span>{{ evento.hora.strftime('%H:%M') }}</span>
                {% endif %}
              </div>
              <p class="text-sm text-gray-600 line-clamp-3 leading-relaxed mb-3">{{ evento.descripcion or 'Sin descripci√≥n' }}</p>
              {% if evento.link_teams %}
              <a href="{{ evento.link_teams }}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 text-xs font-medium transition-colors">
                üîó Unirse al evento
              </a>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm text-center py-8">No hay eventos pr√≥ximos programados.</p>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>
</div>
<!-- Modales -->
<!-- Modal para agregar evento -->
{% if current_user.rol == 'admin' or current_user.is_admin %}
<div id="modal-evento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 transition-all p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 relative">
    <button id="btn-cerrar-modal-evento" type="button" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl font-bold focus:outline-none transition-colors">&times;</button>
    
    <div class="mb-6">
      <h3 class="text-xl font-semibold text-gray-900 mb-2">Nuevo evento</h3>
      <p class="text-sm text-gray-600">Crea un evento para que todo el equipo est√© informado</p>
    </div>
    
    <form id="form-evento" method="POST" action="{{ url_for('home.create_evento') }}" class="space-y-4">
      {{ form_post.csrf_token }}
      
      <!-- T√≠tulo del evento -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">T√≠tulo del evento *</label>
        <input type="text" name="titulo" required placeholder="Ej: Reuni√≥n de equipo, Workshop..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm" />
      </div>
      
      <!-- Fecha y hora en grid -->
      <div class="grid grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">Fecha *</label>
          <input type="date" name="fecha" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm bg-white" />
        </div>
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">Hora</label>
          <input type="time" name="hora" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm bg-white" />
        </div>
      </div>
      
      <!-- Descripci√≥n -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
        <textarea name="descripcion" rows="3" placeholder="Describe de qu√© trata el evento..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm resize-none"></textarea>
      </div>
      
      <!-- Link Teams -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">Enlace de Teams (opcional)</label>
        <input type="url" name="link_teams" placeholder="https://teams.microsoft.com/..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm" />
      </div>
      
      <!-- Botones -->
      <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
        <button type="button" id="btn-cancelar-evento" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">Cancelar</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition-colors">Crear evento</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Modal Nueva Publicaci√≥n -->
<div id="modal-post" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 transition-all p-4" aria-hidden="true">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6 relative">
    <button id="btn-cerrar-modal-post" type="button" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl font-bold focus:outline-none transition-colors">&times;</button>
    
    <div class="mb-6">
      <h3 class="text-xl font-semibold text-gray-900 mb-2">Nueva publicaci√≥n</h3>
      <p class="text-sm text-gray-600">Comparte actualizaciones con tu equipo</p>
    </div>
    
    <form id="post-form-modal" method="POST" action="{{ url_for('home.create_post') }}" enctype="multipart/form-data" class="space-y-6">
      {{ form_post.csrf_token }}
      
      <!-- Selector de visibilidad - PRIMERO -->
      <div class="space-y-3">
        <label class="block text-sm font-medium text-gray-700">Visibilidad de la publicaci√≥n</label>
        <div class="relative">
          <select name="visibility_type" id="visibility-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-200 focus:border-blue-500 text-sm appearance-none cursor-pointer" onchange="toggleProjectSelection()">
            <option value="public">üåê Todos los proyectos (P√∫blico)</option>
            <option value="private">üîí Proyectos espec√≠ficos (Privado)</option>
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>
        
        <!-- Selector de proyectos espec√≠ficos -->
        <div id="projects-container" class="hidden">
          <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
            <label class="text-xs font-medium text-gray-700 mb-3 block">Selecciona los proyectos que podr√°n ver esta publicaci√≥n:</label>
            <div class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar">
              {% if proyectos %}
              {% for proyecto in proyectos %}
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded-lg transition-colors group">
                <input type="checkbox" name="proyectos_visibles" value="{{ proyecto.id }}" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                <span class="text-sm text-gray-800 group-hover:text-gray-900">{{ proyecto.nombre }}</span>
              </label>
              {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Campo oculto para manejar la visibilidad p√∫blica -->
        <input type="hidden" name="proyectos_visibles" value="todos" id="public-visibility-input">
      </div>
      
      <!-- Contenido de la publicaci√≥n -->
      <div class="space-y-3">
        <label class="block text-sm font-medium text-gray-700">Contenido</label>
        <textarea name="content" rows="4" required placeholder="¬øQu√© quieres compartir con el equipo?" class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500 text-sm placeholder-gray-400"></textarea>
      </div>
      
      <!-- Subir imagen mejorada -->
      <div class="space-y-3">
        <label class="block text-sm font-medium text-gray-700">Imagen (opcional)</label>
        
        <!-- √Årea de arrastre mejorada -->
        <div class="relative">
          <input type="file" name="image" id="post-image" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
          <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer">
            <div id="upload-placeholder">
              <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <p class="text-sm text-gray-600">
                <span class="font-medium text-blue-600">Haz clic para subir</span> o arrastra una imagen aqu√≠
              </p>
              <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF hasta 10MB</p>
            </div>
          </div>
        </div>
        
        <!-- Preview de imagen -->
        <div id="preview-container" class="hidden">
          <div class="relative inline-block">
            <img id="preview-image" src="" alt="Vista previa" class="max-h-40 rounded-lg shadow-sm border border-gray-200 object-contain">
            <button type="button" id="remove-image" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold transition-colors">√ó</button>
          </div>
        </div>
      </div>
      
      <!-- Botones -->
      <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
        <button type="button" id="btn-cancelar-post" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">Cancelar</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition-colors">Publicar</button>
      </div>
    </form>
  </div>
</div>

<!-- Fin Modales -->

{% block scripts %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="{{ url_for('home.static', filename='js/home_clean.js') }}"></script>
<script>
// Funci√≥n para manejar la selecci√≥n de visibilidad
function toggleProjectSelection() {
  const select = document.getElementById('visibility-select');
  const container = document.getElementById('projects-container');
  const publicInput = document.getElementById('public-visibility-input');
  
  if (select.value === 'private') {
    container.classList.remove('hidden');
    publicInput.disabled = true;
  } else {
    container.classList.add('hidden');
    publicInput.disabled = false;
    // Limpiar selecciones de proyectos
    document.querySelectorAll('input[name="proyectos_visibles"]:not(#public-visibility-input)').forEach(cb => {
      cb.checked = false;
    });
  }
}

// Funci√≥n para manejar el preview de imagen
function setupImagePreview() {
  const imageInput = document.getElementById('post-image');
  const uploadArea = document.getElementById('upload-area');
  const uploadPlaceholder = document.getElementById('upload-placeholder');
  const previewContainer = document.getElementById('preview-container');
  const previewImage = document.getElementById('preview-image');
  const removeButton = document.getElementById('remove-image');
  
  if (!imageInput || !uploadArea || !previewContainer) return;
  
  // Manejar cambio de archivo
  imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) { // 10MB
        alert('El archivo es demasiado grande. M√°ximo 10MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        uploadArea.classList.add('hidden');
        previewContainer.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });
  
  // Bot√≥n para quitar imagen
  removeButton.addEventListener('click', function() {
    imageInput.value = '';
    previewImage.src = '';
    uploadArea.classList.remove('hidden');
    previewContainer.classList.add('hidden');
  });
  
  // Drag and drop
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('border-blue-400', 'bg-blue-50');
  });
  
  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
  });
  
  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      imageInput.files = files;
      imageInput.dispatchEvent(new Event('change'));
    }
  });
}

// Manejar botones de cancelar
function setupCancelButtons() {
  const cancelPostBtn = document.getElementById('btn-cancelar-post');
  const cancelEventBtn = document.getElementById('btn-cancelar-evento');
  const closePostBtn = document.getElementById('btn-cerrar-modal-post');
  const closeEventBtn = document.getElementById('btn-cerrar-modal-evento');
  
  [cancelPostBtn, closePostBtn].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', () => {
        document.getElementById('modal-post').classList.add('hidden');
        // Limpiar formulario
        document.getElementById('post-form-modal').reset();
        document.getElementById('upload-area').classList.remove('hidden');
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('projects-container').classList.add('hidden');
      });
    }
  });
  
  [cancelEventBtn, closeEventBtn].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', () => {
        document.getElementById('modal-evento').classList.add('hidden');
        document.getElementById('form-evento').reset();
      });
    }
  });
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
  console.log('HOME.HTML CARGADO - Todo funcionando correctamente');
  setupImagePreview();
  setupCancelButtons();
});
</script>
<style>
  .font-sfpro {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-feature-settings: 'liga', 'kern';
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Smooth scrolling for mobile events */
  .overflow-x-auto {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .overflow-x-auto::-webkit-scrollbar {
    display: none;
  }
  
  /* Custom scrollbar para el selector de proyectos */
  .custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f7fafc;
  }
  
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 3px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
  }
  
  /* Men√∫ dropdown de 3 puntos */
  .dropdown-menu {
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 120px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    border: 1px solid #e5e7eb;
  }
  
  .dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    color: #374151;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.15s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
  }
  
  .dropdown-item:hover {
    background-color: #f3f4f6;
  }
  
  .dropdown-item.danger {
    color: #6b7280; /* Color gris normal por defecto - igual que la imagen */
    font-weight: 500;
  }
  
  .dropdown-item.danger:hover {
    background-color: #fef2f2;
    color: #dc2626; /* Solo se pone rojo en hover */
  }
  
  .dropdown-item.danger svg {
    color: #6b7280; /* √çcono gris por defecto */
    transition: color 0.15s ease;
  }
  
  .dropdown-item.danger:hover svg {
    color: #dc2626; /* √çcono rojo solo en hover */
  }
  
  .dropdown-toggle {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    color: #6b7280;
    transition: all 0.15s ease;
  }
  
  .dropdown-toggle:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  
  /* Estilos para el √°rea de upload mejorada */
  #upload-area {
    transition: all 0.2s ease;
  }
  
  #upload-area:hover {
    border-color: #3b82f6;
    background-color: #eff6ff;
  }
  
  /* Animaciones para los modales */
  #modal-post, #modal-evento {
    backdrop-filter: blur(4px);
  }
  
  /* Mejoras para los selects */
  select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  
  /* Estilo para labels mejoradas */
  label {
    font-weight: 500;
    color: #374151;
  }
  
  /* Hover effects para cards */
  .hover\:shadow-sm:hover {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }
</style>
{% endblock %}
{% endblock %}