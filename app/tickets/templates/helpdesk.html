{% extends 'base.html' %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
  body, .helpdesk-scope {
    background: linear-gradient(120deg, #f7f8fa 0%, #f2f3f7 100%) !important;
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', Arial, sans-serif;
  }
  .glassmorphism {
    background: rgba(255,255,255,0.85);
    box-shadow: 0 8px 32px 0 rgba(31,38,135,0.08);
    backdrop-filter: blur(12px);
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.18);
  }
  .glassmorphism-modal {
    background: rgba(255,255,255,0.95) !important;
    box-shadow: 0 8px 32px 0 rgba(31,38,135,0.10);
    backdrop-filter: blur(16px);
    border-radius: 24px;
    border: 1px solid #ececec;
  }
  .tab-btn {
    transition: background 0.2s, color 0.2s;
    border: none;
    outline: none;
    font-family: inherit;
    background: transparent;
  }
  .tab-btn.border-b-2 {
    background: #fffbe6;
    color: #3b3b3c;
    border-bottom: 2px solid #fab522;
  }
  .badge-prioridad {
    display: inline-block;
    padding: 0.25em 0.8em;
    border-radius: 999px;
    font-size: 0.95em;
    font-weight: 500;
    background: #f7f7fa;
    color: #3b3b3c;
    letter-spacing: 0.01em;
    font-family: inherit;
  }
  .badge-prioridad.urgente { background: #ff3b30; color: #fff; }
  .badge-prioridad.alta { background: #ffe08a; color: #3b3b3c; }
  .badge-prioridad.media { background: #e5e5ea; color: #3b3b3c; }
  .badge-prioridad.baja { background: #f2f3f7; color: #3b3b3c; }
  .badge-estatus {
    display: inline-block;
    padding: 0.25em 0.8em;
    border-radius: 999px;
    font-size: 0.95em;
    font-weight: 500;
    background: #f7f7fa;
    color: #3b3b3c;
    letter-spacing: 0.01em;
    font-family: inherit;
  }
  .badge-estatus.abierto { background: #e5e5ea; color: #3b3b3c; }
  .badge-estatus.en-progreso { background: #ffe08a; color: #3b3b3c; }
  .badge-estatus.resuelto { background: #b7ebc6; color: #2e7d32; }
  .tab-content { min-height: 320px; }
  table {
    border-collapse: separate;
    border-spacing: 0 0.5em;
    font-family: inherit;
  }
  th, td {
    font-family: inherit;
    font-size: 1em;
  }
  th {
    font-weight: 600;
    background: transparent;
  }
  tr {
    transition: background 0.18s;
  }
  tr:hover {
    background: #fffbe6 !important;
  }
  .btn-ver-ticket {
    background: #fff;
    border: 1px solid #ececec;
    color: #3b3b3c;
    font-weight: 500;
    border-radius: 12px;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    box-shadow: 0 1px 4px 0 rgba(31,38,135,0.04);
    font-family: inherit;
  }
  .btn-ver-ticket:hover {
    background: #ffe08a;
    color: #3b3b3c;
    box-shadow: 0 2px 8px 0 rgba(31,38,135,0.08);
  }
  #btnNuevoTicket {
    background: #fff;
    color: #3b3b3c;
    border: 1.5px solid #fab522;
    border-radius: 16px;
    font-weight: 600;
    box-shadow: 0 2px 8px 0 rgba(31,38,135,0.04);
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    font-family: inherit;
  }
  #btnNuevoTicket:hover {
    background: #ffe08a;
    color: #3b3b3c;
    box-shadow: 0 4px 16px 0 rgba(31,38,135,0.08);
  }
  .font-sfpro {
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', Arial, sans-serif !important;
  }
</style>
<div class="helpdesk-scope">
  <div class="max-w-4xl w-full mx-auto px-2 sm:px-6 py-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold font-sfpro" style="color:#232323;letter-spacing:-1px;">Centro de ayuda</h1>
      <button id="btnNuevoTicket" class="font-sfpro">+ Nuevo ticket</button>
    </div>
    <div class="glassmorphism rounded-2xl border border-[#fab522]/30 p-0 animate-fadein shadow-xl">
      <div class="flex border-b border-[#fab522]/20 bg-white/95 rounded-t-2xl">
        {% if es_encargado %}
        <button id="tab-gestion" class="tab-btn flex-1 py-3 text-center font-sfpro text-lg font-semibold text-[#3b3b3c] bg-white rounded-t-2xl focus:outline-none transition-all border-b-2 border-[#fab522]">Gestión</button>
        {% endif %}
        <button id="tab-mis" class="tab-btn flex-1 py-3 text-center font-sfpro text-lg font-semibold text-[#3b3b3c]/80 bg-white rounded-t-2xl focus:outline-none transition-all">Mis tickets</button>
      </div>
      {% if es_encargado %}
      <div id="tab-content-gestion" class="tab-content p-6">
        <h2 class="text-xl font-bold mb-2 font-sfpro" style="color:#3b3b3c;">Tickets de gestión de mi categoría</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white/95 glassmorphism rounded-2xl border border-[#fab522]/20">
            <thead>
              <tr class="bg-white/90 text-[#3b3b3c] text-sm border-b border-[#fab522]/20">
                <th class="py-2 px-4 text-left">Título</th>
                <th class="py-2 px-4 text-left">Fecha</th>
                <th class="py-2 px-4 text-left">Prioridad</th>
                <th class="py-2 px-4 text-left">Estatus</th>
                <th class="py-2 px-4 text-left">Levantado por</th>
                <th class="py-2 px-4 text-left">Acción</th>
              </tr>
            </thead>
            <tbody>
              {% for ticket in tickets_gestion %}
              <tr class="border-b border-[#fab522]/20 group">
                <td class="py-2 px-4 font-medium font-sfpro text-[#3b3b3c]">{{ ticket.titulo }}</td>
                <td class="py-2 px-4 text-[#3b3b3c]/80">{{ ticket.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                <td class="py-2 px-4">
                  <span class="badge-prioridad {{ ticket.prioridad|lower }}">{{ ticket.prioridad }}</span>
                </td>
                <td class="py-2 px-4 font-sfpro">
                  <span class="badge-estatus {{ ticket.estatus|lower|replace(' ', '-') }}">{{ ticket.estatus }}</span>
                </td>
                <td class="py-2 px-4 font-sfpro text-[#3b3b3c]/80">{{ ticket.usuario.nombre }} {{ ticket.usuario.apellido_paterno }}</td>
                <td class="py-2 px-4">
                  <button class="btn-ver-ticket font-sfpro" data-id="{{ ticket.id }}">Ver</button>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="6" class="text-center text-gray-400 py-4 font-sfpro">No hay tickets de gestión pendientes.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
      <div id="tab-content-mis" class="tab-content p-6 {% if es_encargado %}hidden{% endif %}">
        <h2 class="text-xl font-bold mb-2 font-sfpro" style="color:#3b3b3c;">Mis tickets</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white/95 glassmorphism rounded-2xl border border-[#fab522]/20">
            <thead>
              <tr class="bg-white/90 text-[#3b3b3c] text-sm border-b border-[#fab522]/20">
                <th class="py-2 px-4 text-left">Título</th>
                <th class="py-2 px-4 text-left">Fecha</th>
                <th class="py-2 px-4 text-left">Prioridad</th>
                <th class="py-2 px-4 text-left">Estatus</th>
                <th class="py-2 px-4 text-left">Acción</th>
              </tr>
            </thead>
            <tbody>
              {% for ticket in tickets_usuario %}
              <tr class="border-b border-[#fab522]/20 group">
                <td class="py-2 px-4 font-medium font-sfpro text-[#3b3b3c]">{{ ticket.titulo }}</td>
                <td class="py-2 px-4 text-[#3b3b3c]/80">{{ ticket.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                <td class="py-2 px-4">
                  <span class="badge-prioridad {{ ticket.prioridad|lower }}">{{ ticket.prioridad }}</span>
                </td>
                <td class="py-2 px-4 font-sfpro">
                  <span class="badge-estatus {{ ticket.estatus|lower|replace(' ', '-') }}">{{ ticket.estatus }}</span>
                </td>
                <td class="py-2 px-4">
                  <button class="btn-ver-ticket font-sfpro" data-id="{{ ticket.id }}">Ver</button>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="text-center text-gray-400 py-4 font-sfpro">No has creado tickets aún.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal Nuevo Ticket -->
    <div id="modalNuevoTicket" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm transition-all">
      <div class="glassmorphism-modal shadow-2xl max-w-lg w-full p-6 relative flex flex-col gap-4 animate-fadein">
        <button type="button" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl font-bold focus:outline-none transition-all duration-200 btn-cancelar-modal">&times;</button>
        <h2 class="text-xl font-semibold mb-2 font-sfpro text-[#3b3b3c]">Nuevo ticket</h2>
        <form id="formNuevoTicket" method="POST" enctype="multipart/form-data" action="{{ url_for('tickets.nuevo_ticket') }}" class="flex flex-col gap-3">
          {{ form.hidden_tag() }}
          <div>
            {{ form.categoria.label(class="block mb-1 text-sm font-medium font-sfpro text-[#3b3b3c]") }}
            {{ form.categoria(class="w-full border border-[#fab522]/40 rounded-xl px-3 py-2 bg-white font-sfpro focus:ring-2 focus:ring-[#fab522] focus:outline-none transition-all duration-200") }}
          </div>
          <div>
            {{ form.titulo.label(class="block mb-1 text-sm font-medium font-sfpro text-[#3b3b3c]") }}
            {{ form.titulo(class="w-full border border-[#fab522]/40 rounded-xl px-3 py-2 bg-white font-sfpro focus:ring-2 focus:ring-[#fab522] focus:outline-none transition-all duration-200") }}
          </div>
          <div>
            {{ form.descripcion.label(class="block mb-1 text-sm font-medium font-sfpro text-[#3b3b3c]") }}
            {{ form.descripcion(class="w-full border border-[#fab522]/40 rounded-xl px-3 py-2 bg-white font-sfpro focus:ring-2 focus:ring-[#fab522] focus:outline-none transition-all duration-200") }}
          </div>
          <div>
            {{ form.prioridad.label(class="block mb-1 text-sm font-medium font-sfpro text-[#3b3b3c]") }}
            {{ form.prioridad(class="w-full border border-[#fab522]/40 rounded-xl px-3 py-2 bg-white font-sfpro focus:ring-2 focus:ring-[#fab522] focus:outline-none transition-all duration-200") }}
          </div>
          <div>
            {{ form.archivo.label(class="block mb-1 text-sm font-medium font-sfpro text-[#3b3b3c]") }}
            {{ form.archivo(class="w-full bg-white font-sfpro focus:ring-2 focus:ring-[#fab522] focus:outline-none transition-all duration-200 border border-[#fab522]/40") }}
          </div>
          <div class="flex justify-end gap-2 mt-4">
            <button type="button" class="bg-[#5e5e5e] hover:bg-[#3b3b3c]/10 text-[#3b3b3c] font-semibold px-4 py-2 rounded-xl transition font-sfpro focus:ring-2 focus:ring-[#fab522] focus:outline-none btn-cancelar-modal">Cancelar</button>
            {{ form.submit(class="bg-[#fab522] hover:bg-[#ffe08a] text-[#3b3b3c] font-semibold px-4 py-2 rounded-xl transition font-sfpro focus:ring-2 focus:ring-[#fab522] focus:outline-none") }}
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Detalle Ticket (renderizado por JS) -->
    <div id="modalDetalleTicket" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm transition-all"></div>
  </div>
</div>
{% block scripts %}
<!-- Inserta este div donde tenga sentido en tu HTML base, por ejemplo al final del body -->
<div id="user-data"
     data-categoria="{{ categorias_encargadas.get(current_user.puesto_trabajo_id, '') }}"
     data-puesto-id="{{ current_user.puesto_trabajo_id }}"
     data-puestos-encargados='{{ categorias_encargadas.keys()|list|tojson }}'
     hidden></div>
<script>
  const userData = document.getElementById('user-data');
  window.miCategoria = userData.dataset.categoria;
  window.mi_puesto_id = parseInt(userData.dataset.puestoId);
  window.puestos_encargados = JSON.parse(userData.dataset.puestosEncargados);
</script>
<script src="{{ url_for('tickets.static', filename='tickets/js/helpdesk.js') }}"></script>
{% endblock %}
{% endblock %}