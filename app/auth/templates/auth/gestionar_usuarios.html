{% extends "base.html" %}

{% block title %}Gestionar Usuarios - Inside{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50/50 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header con estilo Apple -->
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-sm border border-gray-200/50 p-8 mb-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div>
                    <h1 class="text-3xl font-semibold text-gray-900 tracking-tight">Gestionar Usuarios</h1>
                    <p class="mt-2 text-gray-600">Administra todos los usuarios del sistema de forma eficiente</p>
                </div>
                <div class="mt-6 lg:mt-0 flex gap-3">
                    <!-- Botón de Configuración -->
                    <a href="{{ url_for('auth.config') }}" 
                       class="inline-flex items-center justify-center w-12 h-12 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-all duration-200 hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </a>
                    <!-- Botón Crear Usuario -->
                    <button data-action="create" 
                            class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl transition-all duration-200 shadow-sm hover:scale-105">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Nuevo Usuario
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtros Optimizados -->
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-sm border border-gray-200/50 p-6 mb-6">
            <div class="flex flex-col lg:flex-row gap-4">
                <!-- Búsqueda Principal -->
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Buscar usuarios..." 
                               class="w-full h-12 pl-12 pr-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder-gray-500">
                        <svg class="absolute left-4 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Filtros Rápidos -->
                <div class="flex gap-3">
                    <select id="statusFilter" class="h-12 px-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Todos</option>
                        <option value="active">Activos</option>
                        <option value="suspended">Suspendidos</option>
                    </select>
                    
                    <button data-action="clear-filters" 
                            class="h-12 px-4 text-gray-600 hover:text-gray-800 bg-gray-50 hover:bg-gray-100 rounded-xl transition-all">
                        Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Estadísticas con estilo Apple -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100/50 backdrop-blur-xl rounded-2xl border border-blue-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-blue-600">Total</p>
                        <p class="text-2xl font-semibold text-blue-900" id="totalUsers">{{ total_usuarios or 0 }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-green-50 to-green-100/50 backdrop-blur-xl rounded-2xl border border-green-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-green-600">Activos</p>
                        <p class="text-2xl font-semibold text-green-900" id="activeUsers">{{ usuarios_activos or 0 }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-red-50 to-red-100/50 backdrop-blur-xl rounded-2xl border border-red-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-red-600">Suspendidos</p>
                        <p class="text-2xl font-semibold text-red-900" id="suspendedUsers">{{ usuarios_suspendidos or 0 }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-purple-50 to-purple-100/50 backdrop-blur-xl rounded-2xl border border-purple-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-purple-600">Nuevos</p>
                        <p class="text-2xl font-semibold text-purple-900" id="newUsers">{{ usuarios_nuevos or 0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Optimizada con datos reales -->
        <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-sm border border-gray-200/50 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">Lista de Usuarios</h3>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50/50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Usuario</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Contacto</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Puesto</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Último Acceso</th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white/50 divide-y divide-gray-50" id="usersTableBody">
                        {% if usuarios %}
                            {% for user in usuarios %}
                            <tr class="hover:bg-blue-50/30 transition-all duration-200" data-user-id="{{ user.id }}">
                                <!-- Usuario con foto y datos completos -->
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-12 w-12">
                                            {% if user.foto %}
                                                <img class="h-12 w-12 rounded-xl object-cover ring-2 ring-gray-100" 
                                                     src="/uploads/{{ user.foto }}" 
                                                     alt="Foto de {{ user.nombre }}"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            {% else %}
                                                <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center ring-2 ring-gray-100">
                                                    <span class="text-lg font-semibold text-white">{{ user.nombre[0].upper() if user.nombre else 'U' }}</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-semibold text-gray-900">
                                                {{ user.nombre or 'Sin nombre' }} {{ user.apellido_paterno or '' }} {{ user.apellido_materno or '' }}
                                            </div>
                                            <div class="text-xs text-gray-500 font-mono">{{ user.curp or 'Sin CURP' }}</div>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- Contacto -->
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">{{ user.email or 'Sin email' }}</div>
                                    <div class="text-xs text-gray-500">{{ user.telefono or 'Sin teléfono' }}</div>
                                </td>
                                
                                <!-- Puesto/Departamento -->
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ user.puesto_trabajo.nombre if user.puesto_trabajo else 'Sin puesto' }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ user.departamento.nombre if user.departamento else 'Sin departamento' }}
                                    </div>
                                </td>
                                
                                <!-- Estado con mejor diseño -->
                                <td class="px-6 py-4">
                                    {% if user.estatus_id == 1 %}
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 ring-1 ring-green-200">
                                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                            Activo
                                        </span>
                                    {% elif user.estatus_id == 3 %}
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 ring-1 ring-red-200">
                                            <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                                            Suspendido
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 ring-1 ring-yellow-200">
                                            <div class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></div>
                                            {{ user.estatus.nombre if user.estatus else 'Indefinido' }}
                                        </span>
                                    {% endif %}
                                </td>
                                
                                <!-- Último Acceso -->
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    {% if user.last_login %}
                                        <div>{{ user.last_login.strftime('%d/%m/%Y') }}</div>
                                        <div class="text-xs text-gray-400">{{ user.last_login.strftime('%H:%M') }}</div>
                                    {% else %}
                                        <span class="text-gray-400">Nunca</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Acciones con iconos -->
                                <td class="px-6 py-4">
                                    <div class="flex justify-center space-x-2">
                                        <!-- Editar -->
                                        <button data-action="edit" data-user-id="{{ user.id }}" 
                                                class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-all duration-200" 
                                                title="Editar usuario">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        
                                        <!-- Suspender/Activar -->
                                        {% if user.estatus_id == 1 %}
                                            <button data-action="suspend" data-user-id="{{ user.id }}" 
                                                    class="p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-all duration-200" 
                                                    title="Suspender usuario">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                                                </svg>
                                            </button>
                                        {% else %}
                                            <button data-action="activate" data-user-id="{{ user.id }}" 
                                                    class="p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition-all duration-200" 
                                                    title="Activar usuario">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </button>
                                        {% endif %}
                                        
                                        <!-- Ver perfil -->
                                        <button data-action="view" data-user-id="{{ user.id }}" 
                                                class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-50 rounded-lg transition-all duration-200" 
                                                title="Ver perfil">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center">
                                    <div class="text-gray-500">
                                        <div class="w-16 h-16 mx-auto bg-gray-100 rounded-2xl flex items-center justify-center mb-4">
                                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">No hay usuarios registrados</h3>
                                        <p class="text-gray-500 mb-4">Comienza creando tu primer usuario en el sistema.</p>
                                        <button data-action="create" 
                                                class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-all">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            Crear Usuario
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Estilo Apple - Moderno y Responsivo -->
<div id="userModal" class="fixed inset-0 bg-black/20 backdrop-blur-sm hidden z-50 transition-all duration-300 ease-out">
    <div class="flex items-center justify-center min-h-screen px-4 py-6">
        <!-- Modal Container -->
        <div class="relative bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden" id="modalContainer" style="transform: scale(0.95); opacity: 0; transition: all 0.3s ease-out;">
            
            <!-- Header Minimalista -->
            <div class="relative bg-gray-50/50 px-6 py-4 border-b border-gray-100">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
                        <div>
                            <h3 id="modalTitle" class="text-xl font-semibold text-gray-900">Usuario</h3>
                            <p class="text-sm text-gray-500" id="modalSubtitle">Gestión de información</p>
                        </div>
                    </div>
                    <button data-action="close-modal" class="group w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-all duration-200">
                        <svg class="w-4 h-4 text-gray-600 group-hover:text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="overflow-y-auto max-h-[calc(90vh-140px)] custom-scrollbar">
                <form id="userForm" class="p-6" enctype="multipart/form-data">
                    <input type="hidden" id="userId" name="user_id">
                    <input type="hidden" id="modalMode" value="create">

                    <!-- Sección de Foto -->
                    <div class="mb-8 text-center">
                        <div class="relative inline-block">
                            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center overflow-hidden border-4 border-white shadow-lg">
                                <img id="userPhoto" src="" alt="Foto de perfil" class="w-full h-full object-cover hidden">
                                <div id="defaultUserIcon" class="text-center">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <label id="photoUploadLabel" for="photoInput" class="absolute -bottom-1 -right-1 w-8 h-8 bg-blue-500 hover:bg-blue-600 text-white rounded-full cursor-pointer transition-all duration-200 flex items-center justify-center shadow-lg">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </label>
                            <input type="file" id="photoInput" name="foto" accept="image/*" class="hidden" onchange="previewPhoto(this)">
                        </div>
                    </div>

                    <!-- Información Personal -->
                    <div class="space-y-6">
                        <!-- Nombre Completo -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                                <input type="text" name="nombre" id="nombre" required placeholder="Nombre" 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Apellido Paterno *</label>
                                <input type="text" name="apellido_paterno" id="apellido_paterno" required placeholder="Apellido Paterno" 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Apellido Materno</label>
                                <input type="text" name="apellido_materno" id="apellido_materno" placeholder="Apellido Materno" 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>
                        </div>

                        <!-- Contacto -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                <input type="email" name="email" id="email" required placeholder="usuario@ejemplo.com" 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono</label>
                                <input type="tel" name="telefono" id="telefono" placeholder="(555) 123-4567" autocomplete="tel"
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>
                        </div>

                        <!-- Contraseñas -->
                        <div id="passwordSection" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                                <div class="relative">
                                    <input type="password" name="password" id="password" placeholder="••••••••" autocomplete="new-password"
                                           class="w-full px-4 py-3 pr-12 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    <button type="button" onclick="togglePassword('password')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contraseña *</label>
                                <div class="relative">
                                    <input type="password" name="confirm_password" id="confirm_password" placeholder="••••••••" autocomplete="new-password"
                                           class="w-full px-4 py-3 pr-12 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    <button type="button" onclick="togglePassword('confirm_password')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Información Personal Adicional -->
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CURP</label>
                                <input type="text" name="curp" id="curp" placeholder="CURP de 18 caracteres" maxlength="18" 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all uppercase">
                            </div>
                        </div>

                        <!-- Ubicación -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                                <select name="entidad_federativa_id" id="entidad_federativa_id" 
                                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    <option value="">Seleccionar estado</option>
                                    {% if entidades %}
                                        {% for entidad in entidades %}
                                            <option value="{{ entidad.id }}">{{ entidad.nombre }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Municipio</label>
                                <select name="municipio_id" id="municipio_id" 
                                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    <option value="">Primero selecciona un estado</option>
                                </select>
                            </div>
                        </div>

                        <!-- Información Laboral -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-900">Información Laboral</h4>
                            
                            <!-- Primera fila: Departamento y Proyecto -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Departamento</label>
                                    <select name="departamento_id" id="departamento_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if departamentos %}
                                            {% for dep in departamentos %}
                                                <option value="{{ dep.id }}">{{ dep.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Proyecto</label>
                                    <select name="proyecto_id" id="proyecto_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if proyectos %}
                                            {% for proyecto in proyectos %}
                                                <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <!-- Segunda fila: Puesto y Fecha de Ingreso -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Puesto de Trabajo</label>
                                    <select name="puesto_trabajo_id" id="puesto_trabajo_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if puestos %}
                                            {% for puesto in puestos %}
                                                <option value="{{ puesto.id }}">{{ puesto.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Ingreso</label>
                                    <input type="date" name="fecha_ingreso" id="fecha_ingreso" 
                                           class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                </div>
                            </div>

                            <!-- Tercera fila: Estatus y Jefe Inmediato -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Estatus</label>
                                    <select name="estatus_id" id="estatus_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if estatus %}
                                            {% for estado in estatus %}
                                                <option value="{{ estado.id }}">{{ estado.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jefe Inmediato</label>
                                    <select name="jefe_inmediato_id" id="jefe_inmediato_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if usuarios %}
                                            {% for jefe in usuarios %}
                                                <option value="{{ jefe.id }}">{{ jefe.nombre }} {{ jefe.apellido_paterno }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Información Educativa -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-900">Información Educativa</h4>
                            
                            <!-- Primera fila: Ocupación e Institución -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ocupación Específica</label>
                                    <select name="ocupacion_especifica_id" id="ocupacion_especifica_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if ocupaciones %}
                                            {% for ocupacion in ocupaciones %}
                                                <option value="{{ ocupacion.id }}">{{ ocupacion.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Institución Educativa</label>
                                    <select name="institucion_educativa_id" id="institucion_educativa_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if instituciones %}
                                            {% for institucion in instituciones %}
                                                <option value="{{ institucion.id }}">{{ institucion.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <!-- Segunda fila: Nivel de Estudios y Documento -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nivel Máximo de Estudios</label>
                                    <select name="nivel_max_estudios_id" id="nivel_max_estudios_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if niveles_estudio %}
                                            {% for nivel in niveles_estudio %}
                                                <option value="{{ nivel.id }}">{{ nivel.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Documento Probatorio</label>
                                    <select name="documento_probatorio_id" id="documento_probatorio_id" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Seleccionar</option>
                                        {% if documentos %}
                                            {% for documento in documentos %}
                                                <option value="{{ documento.id }}">{{ documento.nombre }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer con Botones -->
            <div class="bg-gray-50/50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                <div class="flex items-center text-sm text-gray-600">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Los campos marcados con * son obligatorios
                </div>
                <div class="flex space-x-3">
                    <button data-action="close-modal" type="button" 
                            class="px-6 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-all duration-200">
                        Cancelar
                    </button>
                    <button id="saveButton" data-action="save-user" type="button" 
                            class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-all duration-200 shadow-sm">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Efectos de glassmorphism y animaciones */
.tab-btn {
    color: rgba(75, 85, 99, 0.7);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.tab-btn.active {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
    color: rgb(59, 130, 246);
    border: 1px solid rgba(59, 130, 246, 0.2);
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
}

.tab-btn:not(.active):hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgb(55, 65, 81);
}

/* Scrollbar personalizado */
.scrollbar-thin::-webkit-scrollbar {
    width: 6px;
}

.scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Animaciones de modal */
#userModal {
    animation: modalFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

#userModal.closing {
    animation: modalFadeOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(8px);
    }
}

@keyframes modalFadeOut {
    from {
        opacity: 1;
        backdrop-filter: blur(8px);
    }
    to {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
}

#modalContainer {
    animation: modalSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

#userModal.closing #modalContainer {
    animation: modalSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes modalSlideIn {
    from {
        transform: scale(0.9) translateY(30px);
        opacity: 0;
    }
    to {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

@keyframes modalSlideOut {
    from {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
    to {
        transform: scale(0.95) translateY(20px);
        opacity: 0;
    }
}

/* Efectos hover para inputs */
input:focus, select:focus {
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
}

/* Botones con efectos hover */
button:hover {
    transform: translateY(-1px);
}

/* Gradientes animados */
.bg-gradient-animated {
    background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Responsive mejoras */
@media (max-width: 768px) {
    #modalContainer {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
    }
    
    .tab-btn {
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .grid-cols-1.md\\:grid-cols-3 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    
    /* Animaciones del modal */
    #userModal.hidden #modalContainer {
        transform: scale(0.96);
        opacity: 0;
    }

    #userModal:not(.hidden) #modalContainer {
        transform: scale(1);
        opacity: 1;
    }

    /* Scrollbar minimalista */
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #e5e7eb transparent;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #d1d5db;
    }

    /* Efectos focus tipo Apple */
    input:focus, select:focus {
        outline: none;
        transform: translateY(-1px);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Transiciones suaves */
    input, select, button {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Hover states minimalistas */
    button:hover {
        transform: translateY(-1px);
    }

    input:hover, select:hover {
        background-color: rgba(249, 250, 251, 0.8);
    }

    /* Estados disabled */
    input:disabled, select:disabled {
        background-color: rgba(243, 244, 246, 0.5);
        color: rgba(107, 114, 128, 0.6);
        cursor: not-allowed;
    }
}
</style>

<script>
// Variables globales
let currentModalMode = 'create';
let currentUserIdModal = null;

// Función para cambiar de pestaña
function switchTab(tabName) {
    // Remover clase active de todos los botones
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Ocultar todos los paneles
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.add('hidden');
    });
    
    // Activar el botón seleccionado
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Mostrar el panel seleccionado
    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
}

// Función para actualizar información rápida
function updateQuickInfo(user) {
    // Función auxiliar para actualizar contenido solo si el elemento existe
    function setTextIfExists(id, text) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = text || '-';
        }
    }
    
    // Actualizar elementos solo si existen
    setTextIfExists('quickName', user ? `${user.nombre || ''} ${user.apellido_paterno || ''}`.trim() || 'Sin nombre' : '-');
    setTextIfExists('quickCurp', user?.curp);
    setTextIfExists('quickEmail', user?.email);
    setTextIfExists('quickPhone', user?.telefono);
    
    // Actualizar badge de estado (solo si existe el elemento)
    const statusBadge = document.getElementById('userStatusBadge');
    if (statusBadge) {
        if (user?.estatus_id === 1) {
            statusBadge.textContent = 'Activo';
            statusBadge.className = 'text-sm font-semibold text-emerald-700';
        } else if (user?.estatus_id === 2) {
            statusBadge.textContent = 'Suspendido';
            statusBadge.className = 'text-sm font-semibold text-red-700';
        } else if (user?.estatus_id === 3) {
            statusBadge.textContent = 'Inactivo';
            statusBadge.className = 'text-sm font-semibold text-gray-700';
        } else {
            statusBadge.textContent = 'Sin estatus';
            statusBadge.className = 'text-sm font-semibold text-gray-500';
        }
    }
}

// Función para abrir el modal de usuario
function openUserModal(mode, userId = null) {
    console.log('openUserModal called:', mode, userId);
    
    currentModalMode = mode;
    currentUserIdModal = userId;
    
    const modal = document.getElementById('userModal');
    const modalContainer = document.getElementById('modalContainer');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const saveButton = document.getElementById('saveButton');
    const passwordSection = document.getElementById('passwordSection');
    const photoUploadLabel = document.getElementById('photoUploadLabel');
    
    // Resetear formulario
    document.getElementById('userForm').reset();
    resetPhoto();
    
    // Configurar modal según el modo
    if (mode === 'create') {
        modalTitle.textContent = 'Nuevo Usuario';
        modalSubtitle.textContent = 'Crear un nuevo usuario en el sistema';
        saveButton.style.display = 'block';
        passwordSection.style.display = 'block';
        photoUploadLabel.style.display = 'block';
        document.getElementById('password').required = true;
        document.getElementById('confirm_password').required = true;
        setFormReadonly(false);
    } else if (mode === 'edit') {
        modalTitle.textContent = 'Editar Usuario';
        modalSubtitle.textContent = 'Modificar información del usuario';
        saveButton.style.display = 'block';
        passwordSection.style.display = 'block';
        photoUploadLabel.style.display = 'block';
        document.getElementById('password').required = false;
        document.getElementById('confirm_password').required = false;
        setFormReadonly(false);
        if (userId) {
            loadUserData(userId);
        }
    } else if (mode === 'view') {
        modalTitle.textContent = 'Información del Usuario';
        modalSubtitle.textContent = 'Detalles completos del usuario';
        saveButton.style.display = 'none';
        passwordSection.style.display = 'none';
        photoUploadLabel.style.display = 'none';
        setFormReadonly(true);
        if (userId) {
            loadUserData(userId);
        }
    }
    
    // Mostrar modal con animación
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContainer.style.transform = 'scale(1)';
        modalContainer.style.opacity = '1';
    }, 10);
}

// Función para mostrar/ocultar contraseña
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.parentElement.querySelector('button');
    const icon = button.querySelector('svg');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
        `;
    } else {
        field.type = 'password';
        icon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        `;
    }
}

// Función para cerrar el modal
function closeUserModal() {
    const modal = document.getElementById('userModal');
    const modalContainer = document.getElementById('modalContainer');
    
    // Animar cierre
    modalContainer.style.transform = 'scale(0.95)';
    modalContainer.style.opacity = '0';
    
    // Ocultar modal después de la animación
    setTimeout(() => {
        modal.classList.add('hidden');
        document.getElementById('userForm').reset();
        resetPhoto();
        currentModalMode = 'create';
        currentUserIdModal = null;
    }, 300);
}

// Función para hacer readonly los campos en modo vista
function setFormReadonly(readonly) {
    const inputs = document.querySelectorAll('#userForm input, #userForm select');
    inputs.forEach(input => {
        if (readonly) {
            input.setAttribute('readonly', true);
            input.setAttribute('disabled', true);
            input.classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
            input.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
    });
    
    // Manejar el input de archivo por separado
    const fileInput = document.getElementById('photoInput');
    if (readonly) {
        fileInput.disabled = true;
    } else {
        fileInput.disabled = false;
    }
}

// Función para cargar datos del usuario
function loadUserData(userId) {
    fetch(`/auth/get_user_data/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                
                // Función auxiliar para asignar valor solo si el elemento existe
                function setValueIfExists(id, value) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value || '';
                    }
                }
                
                // Llenar formulario con datos del usuario - solo campos que existen
                setValueIfExists('userId', user.id);
                setValueIfExists('nombre', user.nombre);
                setValueIfExists('apellido_paterno', user.apellido_paterno);
                setValueIfExists('apellido_materno', user.apellido_materno);
                setValueIfExists('curp', user.curp);
                setValueIfExists('email', user.email);
                setValueIfExists('telefono', user.telefono);
                setValueIfExists('fecha_ingreso', user.fecha_ingreso);
                setValueIfExists('estatus_id', user.estatus_id);
                setValueIfExists('departamento_id', user.departamento_id);
                setValueIfExists('proyecto_id', user.proyecto_id);
                setValueIfExists('puesto_trabajo_id', user.puesto_trabajo_id);
                setValueIfExists('jefe_inmediato_id', user.jefe_inmediato_id);
                setValueIfExists('ocupacion_especifica_id', user.ocupacion_especifica_id);
                setValueIfExists('institucion_educativa_id', user.institucion_educativa_id);
                setValueIfExists('nivel_max_estudios_id', user.nivel_max_estudios_id);
                setValueIfExists('documento_probatorio_id', user.documento_probatorio_id);
                setValueIfExists('entidad_federativa_id', user.entidad_federativa_id);
                
                // Cargar municipios si hay entidad seleccionada
                if (user.entidad_federativa_id) {
                    loadMunicipios(user.entidad_federativa_id, user.municipio_id);
                }
                
                // Mostrar foto si existe
                if (user.foto) {
                    showUserPhoto(`/uploads/${user.foto}`);
                } else {
                    resetPhoto();
                }
                
                // Actualizar información rápida si está en modo view
                if (currentModalMode === 'view') {
                    updateQuickInfo(user);
                }
            } else {
                showAlert('Error', data.error || 'Error al cargar datos del usuario', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error', 'Error al conectar con el servidor', 'error');
        });
}

// Función para guardar usuario (crear o editar)
function saveUser() {
    const mode = currentModalMode;
    const userId = currentUserIdModal;
    const form = document.getElementById('userForm');
    const formData = new FormData(form);
    
    // Validar contraseñas si es requerido
    if (mode === 'create' || (mode === 'edit' && document.getElementById('password').value)) {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (password !== confirmPassword) {
            showAlert('Error', 'Las contraseñas no coinciden', 'error');
            return;
        }
    }
    
    let url, method;
    if (mode === 'create') {
        url = '/auth/crear_usuario';
        method = 'POST';
    } else if (mode === 'edit') {
        url = `/auth/actualizar_usuario/${userId}`;
        method = 'POST';
    }
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('¡Éxito!', data.message, 'success');
            closeUserModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error', data.error || `Error al ${mode === 'create' ? 'crear' : 'actualizar'} usuario`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error', 'Error al conectar con el servidor', 'error');
    });
}

// Función para previsualizar foto
function previewPhoto(input) {
    console.log('previewPhoto called', input.files); // Debug
    if (input.files && input.files[0]) {
        const file = input.files[0];
        console.log('File selected:', file.name, file.type); // Debug
        
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
            showAlert('Error', 'Por favor selecciona un archivo de imagen válido', 'error');
            input.value = '';
            return;
        }
        
        // Validar tamaño (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showAlert('Error', 'La imagen es muy grande. Máximo 5MB permitido', 'error');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log('File read successfully'); // Debug
            showUserPhoto(e.target.result);
        };
        reader.onerror = function() {
            console.error('Error reading file'); // Debug
            showAlert('Error', 'Error al leer el archivo', 'error');
        };
        reader.readAsDataURL(file);
    }
}

// Función para mostrar foto del usuario
function showUserPhoto(src) {
    const userPhoto = document.getElementById('userPhoto');
    const defaultIcon = document.getElementById('defaultUserIcon');
    
    userPhoto.src = src;
    userPhoto.classList.remove('hidden');
    defaultIcon.classList.add('hidden');
}

// Función para resetear foto
function resetPhoto() {
    const userPhoto = document.getElementById('userPhoto');
    const defaultIcon = document.getElementById('defaultUserIcon');
    const photoInput = document.getElementById('photoInput');
    
    userPhoto.classList.add('hidden');
    defaultIcon.classList.remove('hidden');
    photoInput.value = '';
}

// Función para cargar municipios dinámicamente
function loadMunicipios(entidadId, selectedMunicipioId = null) {
    const municipioSelect = document.getElementById('municipio_id');
    
    if (!municipioSelect) return;
    
    municipioSelect.innerHTML = '<option value="">Cargando municipios...</option>';
    
    fetch(`/auth/get_municipios/${entidadId}`)
        .then(response => response.json())
        .then(data => {
            municipioSelect.innerHTML = '<option value="">Seleccionar municipio</option>';
            data.municipios.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio.id;
                option.textContent = municipio.nombre;
                if (selectedMunicipioId && municipio.id == selectedMunicipioId) {
                    option.selected = true;
                }
                municipioSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar municipios:', error);
            municipioSelect.innerHTML = '<option value="">Error al cargar municipios</option>';
        });
}

// Función para cambiar estado del usuario
function toggleUserStatus(userId, activate) {
    const action = activate ? 'activar' : 'suspender';
    const title = activate ? '¿Activar usuario?' : '¿Suspender usuario?';
    const message = activate ? 
        'El usuario podrá acceder al sistema normalmente.' :
        'El usuario no podrá acceder al sistema hasta que sea activado nuevamente.';
    
    showConfirmDialog(
        title,
        message,
        () => {
            fetch(`/auth/toggle_user_status/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('¡Éxito!', data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('Error', data.error || 'Error al cambiar estado', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error', 'Error al conectar con el servidor', 'error');
            });
        }
    );
}

// Funciones de filtrado y búsqueda
function clearFilters() {
    document.getElementById('searchInput').value = '';
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) statusFilter.value = '';
    filterUsers();
}

function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter');
    const statusValue = statusFilter ? statusFilter.value : '';
    
    const rows = document.querySelectorAll('#usersTableBody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.querySelector('td')) { // Asegurar que no es la fila de "no hay usuarios"
            const userName = row.cells[0]?.textContent.toLowerCase() || '';
            const userEmail = row.cells[1]?.textContent.toLowerCase() || '';
            const userStatus = row.cells[3]?.textContent.toLowerCase() || '';
            
            const matchesSearch = userName.includes(searchTerm) || userEmail.includes(searchTerm);
            const matchesStatus = !statusValue || 
                (statusValue === 'active' && userStatus.includes('activo')) ||
                (statusValue === 'suspended' && userStatus.includes('suspendido'));
            
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    });
}

function exportUsers() {
    // Función para exportar la lista de usuarios
    console.log('Exportando usuarios...');
}

// Función para cargar municipios dinámicamente
document.getElementById('entidad_federativa_id').addEventListener('change', function() {
    const entidadId = this.value;
    const municipioSelect = document.getElementById('municipio_id');
    
    // Limpiar opciones de municipio
    municipioSelect.innerHTML = '<option value="">Cargando municipios...</option>';
    
    if (entidadId) {
        fetch(`/auth/get_municipios/${entidadId}`)
            .then(response => response.json())
            .then(data => {
                municipioSelect.innerHTML = '<option value="">Seleccionar municipio</option>';
                data.municipios.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio.id;
                    option.textContent = municipio.nombre;
                    municipioSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar municipios:', error);
                municipioSelect.innerHTML = '<option value="">Error al cargar municipios</option>';
            });
    } else {
        municipioSelect.innerHTML = '<option value="">Primero selecciona un estado</option>';
    }
});

// Validación de contraseñas - Manejado dentro de DOMContentLoaded

// Validación de CURP - Manejado dentro de DOMContentLoaded

// Manejo de formularios - Removido porque el formulario se maneja por el modal unificado

// Funciones para manejar eventos - Removidas porque se manejan por event delegation
function editUser(userId) {
    openUserModal('edit', userId);
}

function suspendUser(userId) {
    toggleUserStatus(userId, false);
}

function activateUser(userId) {
    toggleUserStatus(userId, true);
}

// Función para mostrar alertas bonitas
function showAlert(title, message, type = 'info') {
    // Crear el modal de alerta
    const alertHtml = `
        <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 transform transition-all">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 ${
                        type === 'success' ? 'bg-green-100' : 
                        type === 'error' ? 'bg-red-100' : 'bg-blue-100'
                    }">
                        ${type === 'success' ? 
                            '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                            type === 'error' ?
                            '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' :
                            '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                        }
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                </div>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex justify-end">
                    <button data-action="close-alert" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Agregar al DOM
    document.body.insertAdjacentHTML('beforeend', alertHtml);
}

// Función para mostrar diálogo de confirmación
function showConfirmDialog(title, message, onConfirm) {
    const confirmHtml = `
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 transform transition-all">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                </div>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex justify-end space-x-3">
                    <button data-action="close-confirm" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button data-action="confirm-action" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Guardar la función de confirmación
    window.pendingConfirmAction = onConfirm;
    
    // Agregar al DOM
    document.body.insertAdjacentHTML('beforeend', confirmHtml);
}

function closeAlert() {
    const modal = document.getElementById('alertModal');
    if (modal) modal.remove();
}

function closeConfirm() {
    const modal = document.getElementById('confirmModal');
    if (modal) modal.remove();
    window.pendingConfirmAction = null;
}

function confirmAction() {
    if (window.pendingConfirmAction) {
        window.pendingConfirmAction();
    }
    closeConfirm();
}

// Event listeners para el modal
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - Setting up event listeners'); // Debug
    
    // Event delegation para botones de acción
    document.addEventListener('click', function(e) {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        
        e.preventDefault(); // Prevenir comportamiento por defecto
        
        const action = button.getAttribute('data-action');
        const userId = button.getAttribute('data-user-id');
        
        console.log('Button clicked:', action, 'User ID:', userId); // Debug
        
        switch(action) {
            case 'create':
                console.log('Opening create modal'); // Debug
                openUserModal('create');
                break;
            case 'edit':
                console.log('Opening edit modal for user:', userId); // Debug
                openUserModal('edit', parseInt(userId));
                break;
            case 'view':
                console.log('Opening view modal for user:', userId); // Debug
                openUserModal('view', parseInt(userId));
                break;
            case 'suspend':
                console.log('Suspending user:', userId); // Debug
                toggleUserStatus(parseInt(userId), false);
                break;
            case 'activate':
                console.log('Activating user:', userId); // Debug
                toggleUserStatus(parseInt(userId), true);
                break;
            case 'clear-filters':
                console.log('Clearing filters'); // Debug
                clearFilters();
                break;
            case 'close-modal':
                console.log('Closing modal'); // Debug
                closeUserModal();
                break;
            case 'save-user':
                console.log('Saving user'); // Debug
                saveUser();
                break;
            case 'close-alert':
                console.log('Closing alert'); // Debug
                closeAlert();
                break;
            case 'close-confirm':
                console.log('Closing confirm'); // Debug
                closeConfirm();
                break;
            case 'confirm-action':
                console.log('Confirming action'); // Debug
                confirmAction();
                break;
        }
    });
    
    // Event listeners para pestañas del modal
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const tabName = this.getAttribute('data-tab');
            if (tabName) {
                switchTab(tabName);
            }
        });
    });
    
    // Listener para cambio de estado en formulario
    const entidadSelect = document.getElementById('entidad_federativa_id');
    if (entidadSelect) {
        entidadSelect.addEventListener('change', function() {
            const entidadId = this.value;
            if (entidadId) {
                loadMunicipios(entidadId);
            } else {
                const municipioSelect = document.getElementById('municipio_id');
                if (municipioSelect) {
                    municipioSelect.innerHTML = '<option value="">Primero selecciona un estado</option>';
                }
            }
        });
    }
    
    // Validación de contraseñas en tiempo real
    const confirmPasswordInput = document.getElementById('confirm_password');
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('blur', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            
            if (password && confirmPassword && password !== confirmPassword) {
                this.setCustomValidity('Las contraseñas no coinciden');
                this.style.borderColor = '#ef4444';
            } else {
                this.setCustomValidity('');
                this.style.borderColor = '#d1d5db';
            }
        });
    }
    
    // Validación de CURP en tiempo real
    const curpInput = document.getElementById('curp');
    if (curpInput) {
        curpInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
            const curpPattern = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9A-Z][0-9]$/;
            
            if (this.value.length === 18 && !curpPattern.test(this.value)) {
                this.setCustomValidity('CURP no válido');
                this.style.borderColor = '#ef4444';
            } else {
                this.setCustomValidity('');
                this.style.borderColor = '#d1d5db';
            }
        });
    }
    
    // Cerrar modal al hacer clic fuera
    const modal = document.getElementById('userModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserModal();
            }
        });
    }
    
    // Listener para Enter en el formulario
    const userForm = document.getElementById('userForm');
    if (userForm) {
        userForm.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && currentModalMode !== 'view') {
                e.preventDefault();
                saveUser();
            }
        });
    }
    
    // Event listeners para filtros
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');

    if (searchInput) searchInput.addEventListener('input', filterUsers);
    if (statusFilter) statusFilter.addEventListener('change', filterUsers);
});

// Funciones de utilidad adicionales
function openConfiguration() {
    window.location.href = '/admin/configuracion';
}

</script>

{% endblock content %}
