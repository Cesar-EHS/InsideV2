{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen">
  <!-- Layout para m√≥vil: eventos arriba horizontal, publicaciones abajo -->
  <div class="lg:hidden pt-0">
    <!-- Eventos horizontales en m√≥vil -->
    <div class="px-6 mb-3">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-medium text-gray-900">Pr√≥ximos eventos</h2>
        {% if current_user.rol == 'admin' or current_user.is_admin %}
        <button id="btn-nuevo-evento-mobile" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Agregar
        </button>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        <div class="flex gap-4 pb-2" style="width: max-content;">
          {% for evento in eventos[:5] %}
          <div class="w-64 bg-white rounded-xl shadow-sm p-4 border border-gray-100 flex-shrink-0 group relative" 
               data-tipo="evento" 
               data-fecha="{{ evento.fecha.isoformat() }}" 
               data-proyecto="{{ evento.proyecto.nombre if evento.proyecto else 'Sin proyecto' }}">
            <!-- Men√∫ de 3 puntos para eventos m√≥viles -->
            {% if current_user.rol == 'admin' or current_user.is_admin %}
            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <div class="relative dropdown">
                <button class="dropdown-toggle" data-dropdown-id="evento-mobile-{{ evento.id }}" type="button" aria-label="Opciones de evento">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                  </svg>
                </button>
                <div id="dropdown-evento-mobile-{{ evento.id }}" class="dropdown-menu">
                  <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_evento', id=evento.id) }}" data-delete-type="evento" type="button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
            {% endif %}
            
            <h3 class="font-medium text-gray-900 mb-2 line-clamp-2">{{ evento.titulo }}</h3>
            <div class="flex items-center gap-3 text-sm text-gray-600 mb-2">
              <span>{{ evento.fecha.strftime('%d/%m') }}</span>
              {% if evento.hora %}
              <span>{{ evento.hora.strftime('%H:%M') }}</span>
              {% if evento.get_hora_fin() %}
                <span class="text-gray-400">- {{ evento.get_hora_fin().strftime('%H:%M') }}</span>
              {% endif %}
              {% endif %}
            </div>
            <p class="text-sm text-gray-600 line-clamp-3 mb-3">{{ evento.descripcion or 'Sin descripci√≥n' }}</p>
            
            <!-- Botones de participaci√≥n m√≥vil -->
            <div class="flex items-center justify-between mb-3">
              {% set estado_actual = evento.get_estado_usuario(current_user.id) %}
              <div class="flex gap-2">
                {% if estado_actual != 'confirmado' %}
                <!-- Bot√≥n confirmar (solo si no est√° confirmado) -->
                <button 
                  class="participar-btn flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-green-50 hover:text-green-600 border border-gray-200"
                  data-evento-id="{{ evento.id }}" 
                  data-accion="confirmado">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  <span class="hidden sm:inline">Confirmar</span>
                </button>
                {% endif %}
                
                {% if estado_actual != 'declinado' %}
                <!-- Bot√≥n declinar (solo si no est√° declinado) -->
                <button 
                  class="participar-btn flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-red-50 hover:text-red-600 border border-gray-200"
                  data-evento-id="{{ evento.id }}" 
                  data-accion="declinado">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  <span class="hidden sm:inline">Declinar</span>
                </button>
                {% endif %}
                
                {% if estado_actual == 'confirmado' %}
                <!-- Bot√≥n para quitar confirmaci√≥n -->
                <button 
                  class="participar-btn flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-green-100 text-green-700 border border-green-200"
                  data-evento-id="{{ evento.id }}" 
                  data-accion="declinado">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  <span class="hidden sm:inline">Quitar confirmaci√≥n</span>
                </button>
                {% endif %}
                
                {% if estado_actual == 'declinado' %}
                <!-- Bot√≥n para quitar declinaci√≥n -->
                <button 
                  class="participar-btn flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-red-100 text-red-700 border border-red-200"
                  data-evento-id="{{ evento.id }}" 
                  data-accion="confirmado">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  <span class="hidden sm:inline">Confirmar asistencia</span>
                </button>
                {% endif %}
              </div>
              
              <!-- Ver participantes -->
              <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="abrirModalParticipantes({{ evento.id }})">
                Ver participantes
              </button>
            </div>
            
            {% if evento.link_teams %}
            <a href="{{ evento.link_teams }}" target="_blank" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 text-sm font-medium">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0189 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0189 1.3332-.946 2.4189-2.1569 2.4189Z"/>
              </svg>
              Unirse
            </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Layout para desktop -->
  <div class="flex flex-col lg:flex-row lg:px-6 lg:gap-8 lg:items-start">
    <!-- Publicaciones - 2/3 en desktop -->
    <main class="lg:w-2/3 pt-0">
      <!-- Nueva publicaci√≥n integrada con filtros -->
      {% if current_user.rol == 'admin' or current_user.is_admin %}
      <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
        <!-- Crear publicaci√≥n -->
        <div class="flex items-center gap-3 mb-3">
          <img src="{{ usuario.foto_url }}" alt="Foto de {{ usuario.nombre }}" class="w-8 h-8 rounded-full object-cover" onerror="this.onerror=null; this.src='/static/default_user.png';">
          <button id="btn-abrir-modal-post" class="bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full px-3 py-2 w-full text-left focus:outline-none focus:ring-2 focus:ring-blue-200 transition-all duration-300 ease-in-out font-medium text-sm transform hover:scale-[1.02]" aria-label="¬øListo para publicar?" type="button">
            ¬øListo para publicar, {{ usuario.nombre.split(' ')[0] }}?
          </button>
        </div>
        
        <!-- Filtros minimalistas estilo Apple - Din√°micos -->
        <div x-data="{ open: false }" class="border-t border-gray-200 pt-3">
          <button type="button" @click="open = !open" class="flex items-center justify-between w-full text-left text-gray-600 hover:text-blue-600 text-sm transition-all focus:outline-none group" aria-expanded="false" aria-controls="filtros-form">
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-6.414 6.414A1 1 0 0013 13.414V19a1 1 0 01-1.447.894l-2-1A1 1 0 009 18v-4.586a1 1 0 00-.293-.707L2.293 6.707A1 1 0 012 6V4z"/>
              </svg>
              Filtrar publicaciones
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform group-hover:text-blue-600" :class="open ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          
          <div x-show="open" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 transform scale-100" x-transition:leave-end="opacity-0 transform scale-95" class="mt-3 space-y-3" style="display: none;" @click.away="open = false">
            
            <!-- Filtros en dise√±o minimalista y compacto -->
            <div class="grid grid-cols-4 gap-2">
              <!-- A√±o -->
              <div class="space-y-1">
                <label class="text-xs font-medium text-gray-500">A√±o</label>
                <select id="filter_year" name="filter_year" class="w-full appearance-none bg-white border border-gray-200 rounded-md px-2 py-1 text-xs focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all">
                  <option value="">Todos</option>
                  {% for year in a√±os_posts %}
                    <option value="{{ year }}" {% if filter_year == year %}selected{% endif %}>{{ year }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Mes -->
              <div class="space-y-1">
                <label class="text-xs font-medium text-gray-500">Mes</label>
                <select id="filter_month" name="filter_month" class="w-full appearance-none bg-white border border-gray-200 rounded-md px-2 py-1 text-xs focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all">
                  <option value="">Todos</option>
                  {% for month in meses %}
                    <option value="{{ month }}" {% if filter_month == month %}selected{% endif %}>{{ month }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Proyecto -->
              <div class="space-y-1">
                <label class="text-xs font-medium text-gray-500">Proyecto</label>
                <select id="filter_project" name="filter_project" class="w-full appearance-none bg-white border border-gray-200 rounded-md px-2 py-1 text-xs focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all">
                  <option value="">Todos</option>
                  {% for proyecto in proyectos %}
                    <option value="{{ proyecto.id }}" {% if filter_project and filter_project|int == proyecto.id %}selected{% endif %}>{{ proyecto.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Autor -->
              <div class="space-y-1">
                <label class="text-xs font-medium text-gray-500">Autor</label>
                <select id="filter_user" name="filter_user" class="w-full appearance-none bg-white border border-gray-200 rounded-md px-2 py-1 text-xs focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all">
                  <option value="">Todos</option>
                  {% for user in usuarios %}
                    <option value="{{ user.id }}" {% if filter_user and filter_user|int == user.id %}selected{% endif %}>{{ user.nombre }} {{ user.apellido_paterno }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <!-- Filtros din√°micos adicionales -->
            <div class="border-t border-gray-100 pt-3 mt-3">
              <div class="flex flex-wrap gap-2 mb-3">
                <button data-filter="todo" class="px-3 py-1 text-xs rounded-full border transition-all bg-blue-50 text-blue-600 border-blue-200">
                  Todo
                </button>
                <button data-filter="publicaciones" class="px-3 py-1 text-xs rounded-full border transition-all bg-gray-50 text-gray-600 border-gray-200">
                  Publicaciones
                </button>
                <button data-filter="eventos" class="px-3 py-1 text-xs rounded-full border transition-all bg-gray-50 text-gray-600 border-gray-200">
                  Eventos
                </button>
                {% for proyecto in proyectos %}
                <button data-filter="proyecto" data-proyecto="{{ proyecto.nombre }}" class="px-3 py-1 text-xs rounded-full border transition-all bg-gray-50 text-gray-600 border-gray-200">
                  {{ proyecto.nombre }}
                </button>
                {% endfor %}
              </div>
              
              <!-- B√∫squeda y fecha -->
              <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="space-y-1">
                  <label class="text-xs font-medium text-gray-500">Buscar</label>
                  <input type="text" id="search-filter" placeholder="Buscar por t√≠tulo, contenido o autor..." class="w-full border border-gray-200 rounded-md px-2 py-1 text-xs focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all">
                </div>
                <div class="space-y-1">
                  <label class="text-xs font-medium text-gray-500">Fecha espec√≠fica</label>
                  <input type="date" id="date-filter" class="w-full border border-gray-200 rounded-md px-2 py-1 text-xs focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all">
                </div>
              </div>
              
              <button onclick="clearAllFilters()" class="w-full px-3 py-2 text-xs text-gray-600 bg-gray-50 border border-gray-200 rounded-md hover:bg-gray-100 transition-all">
                <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Limpiar todos los filtros
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Publicaciones optimizadas -->
      {% if posts %}
      <div class="space-y-4">
        {% for post in posts %}
        <article class="bg-white rounded-xl border border-gray-200 p-4 group relative transition-all duration-300 ease-in-out hover:shadow-md hover:border-blue-200" 
                 data-tipo="publicacion" 
                 data-fecha="{{ post.timestamp.isoformat() }}" 
                 data-proyecto="{{ post.user.proyecto.nombre if post.user.proyecto else 'Sin proyecto' }}" 
                 data-author="{{ post.user.nombre }}">
          {% if (post.user_id == current_user.id or current_user.is_admin) and (current_user.rol == 'admin' or current_user.is_admin) %}
          <!-- Men√∫ de 3 puntos para publicaciones -->
          <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
            <div class="relative dropdown">
              <button class="dropdown-toggle" data-dropdown-id="post-{{ post.id }}" type="button" aria-label="Opciones de publicaci√≥n">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                </svg>
              </button>
              <div id="dropdown-post-{{ post.id }}" class="dropdown-menu">
                <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_post', post_id=post.id) }}" data-delete-type="publicacion" type="button">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                  Eliminar
                </button>
              </div>
            </div>
          </div>
          {% endif %}
          
          <div class="mb-4">
            <div class="flex items-center gap-3 mb-3">
              <img src="{{ post.user.foto_url }}" alt="Foto de {{ post.user.nombre }} {{ post.user.apellido_paterno }}" class="w-12 h-12 rounded-full object-cover">
              <div class="flex-1">
                <h2 class="text-gray-900 font-medium text-base">{{ post.user.nombre }} {{ post.user.apellido_paterno }}</h2>
                <div class="flex items-center gap-2">
                  <time class="text-gray-500 text-sm">{{ post.timestamp.strftime('%d/%m/%Y %H:%M') }}</time>
                  <!-- Icono de visibilidad mejorado -->
                  {% if post.visible_para_todos %}
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Visible para todos los proyectos">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-xs text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full font-medium">P√∫blico</span>
                  </div>
                  {% elif post.proyectos_nombres %}
                  <div class="relative group flex items-center gap-1">
                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Visible solo para proyectos espec√≠ficos">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <span class="text-xs text-orange-700 bg-orange-100 px-2 py-0.5 rounded-full font-medium">Privado</span>
                    <!-- Tooltip mejorado -->
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-200 whitespace-nowrap z-20 shadow-lg">
                      <div class="font-medium mb-1">Visible para:</div>
                      <div class="text-gray-300">{{ post.proyectos_nombres|join(', ') }}</div>
                      <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            <p class="text-gray-800 text-base leading-relaxed mb-4">{{ post.content }}</p>
          </div>
          
          {% if post.image_filename %}
          <div class="mb-4">
            <img src="{{ url_for('home.static', filename='uploads/' + post.image_filename) }}" alt="Imagen adjunta" class="w-full rounded-xl object-contain max-h-96 border border-gray-200">
          </div>
          {% endif %}
          
          <div class="flex items-center gap-6 text-gray-600 text-sm mb-4">
            {% set user_love = post.reactions|selectattr("user_id", "equalto", current_user.id)|selectattr("type", "equalto", "love")|list|length > 0 %}
            <button class="flex items-center gap-2 {% if user_love %}text-red-500{% else %}hover:text-red-500{% endif %} focus:outline-none transition" data-post-id="{{ post.id }}" data-reaction="love" type="button">
              <svg class="w-5 h-5" fill="{% if user_love %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
              <span class="font-medium hidden sm:inline">Me Gusta</span>
              <span id="love-count-{{ post.id }}" class="ml-1">{{ post.reactions|selectattr('type', 'equalto', 'love')|list|length }}</span>
            </button>
            <button id="btn-comments-toggle-{{ post.id }}" data-post-id="{{ post.id }}" class="flex items-center gap-2 hover:text-blue-600 transition" aria-expanded="false" aria-controls="comments-section-{{ post.id }}" type="button">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10m0 0V6a2 2 0 00-2-2H9a2 2 0 00-2 2v2m10 0v8a2 2 0 01-2 2H9a2 2 0 01-2-2v-8m10 0H7m6 4h.01"/>
              </svg>
              <span class="font-medium hidden sm:inline">Comentar</span>
              <span class="ml-1">{{ post.comments.count() }}</span>
            </button>
          </div>
          
          <section id="comments-section-{{ post.id }}" class="hidden space-y-3" aria-live="polite" tabindex="0">
            <ul class="space-y-3" id="comentarios-lista-{{ post.id }}">
              {% set comentarios = post.comments|sort(attribute='timestamp', reverse=True) %}
              {% for comment in comentarios[:5] %}
              <li class="flex space-x-3 group relative" data-comment-id="{{ comment.id }}">
                <!-- Men√∫ de 3 puntos para comentarios (lado derecho) -->
                {% if (comment.user_id == current_user.id or current_user.is_admin) %}
                <div class="absolute right-0 top-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                  <div class="relative dropdown">
                    <button class="dropdown-toggle" data-dropdown-id="comment-{{ comment.id }}" type="button" aria-label="Opciones de comentario">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                      </svg>
                    </button>
                    <div id="dropdown-comment-{{ comment.id }}" class="dropdown-menu">
                      <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_comment', comment_id=comment.id) }}" data-delete-type="comentario" type="button">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Eliminar
                      </button>
                    </div>
                  </div>
                </div>
                {% endif %}
                <img title="{{ comment.user.nombre }} {{ comment.user.apellido_paterno }}" class="w-8 h-8 rounded-full flex-shrink-0" src="{{ comment.user.foto_url if comment.user.foto_url else url_for('auth.static', filename='img/default_user.png') }}" alt="Avatar">
                <div class="flex-1 bg-gray-100 rounded-xl px-3 py-2">
                  <p class="text-gray-800 text-sm">{{ comment.content }}</p>
                </div>
              </li>
              {% endfor %}
            </ul>
            
            <!-- Bot√≥n "Ver m√°s comentarios" -->
            {% if post.comments.count() > 5 %}
            {% set remaining_comments = post.comments.count() - 5 %}
            <button id="load-more-{{ post.id }}" 
                    class="mostrar-mas-comentarios text-sm font-medium hover:underline cursor-pointer"
                    style="color: #3c3c3b;"
                    data-post-id="{{ post.id }}"
                    data-page="1">
              Ver m√°s comentarios ({{ remaining_comments }} restante{% if remaining_comments != 1 %}s{% endif %})
            </button>
            {% endif %}
            
            <form method="POST" action="{{ url_for('home.add_comment', post_id=post.id) }}" class="flex gap-2 mt-3 comment-form" novalidate>
              {{ form_post.csrf_token }}
              <textarea name="comment_content" rows="1" required placeholder="Escribe un comentario..." class="flex-1 border border-gray-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-blue-500 text-sm resize-none placeholder-gray-400"></textarea>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-xl transition-colors text-sm">Enviar</button>
            </form>
          </section>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
        </svg>
        <p class="text-gray-500 text-lg">No hay publicaciones disponibles</p>
        <p class="text-gray-400 text-sm mt-1">Las publicaciones aparecer√°n aqu√≠ cuando sean creadas</p>
      </div>
      {% endif %}
    </main>

    <!-- Sidebar de eventos - 1/3 en desktop -->
    <aside class="lg:w-1/3 hidden lg:block lg:mt-0 mt-6" role="complementary">
      <div class="lg:sticky lg:top-6 space-y-6">
        <!-- Header con bot√≥n agregar evento -->
        <div class="rounded-2xl p-0">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-medium text-gray-900">Pr√≥ximos eventos</h2>
            {% if current_user.rol == 'admin' or current_user.is_admin %}
            <button id="btn-nuevo-evento" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded-xl transition-colors flex items-center gap-1" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Agregar
            </button>
            {% endif %}
          </div>

          <!-- Filtros para eventos - Dise√±o minimalista y din√°mico -->
          <div class="mb-4">
            <div class="flex items-center gap-3 mb-3">
              <span class="text-sm font-medium text-gray-700">Filtros:</span>
              <div class="flex gap-2 flex-1">
                <select id="filter_evento_mes" name="filter_evento_mes" class="text-xs border border-gray-200 rounded-md px-2 py-1 bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all appearance-none">
                  <option value="">Mes</option>
                  <option value="1">Ene</option>
                  <option value="2">Feb</option>
                  <option value="3">Mar</option>
                  <option value="4">Abr</option>
                  <option value="5">May</option>
                  <option value="6">Jun</option>
                  <option value="7">Jul</option>
                  <option value="8">Ago</option>
                  <option value="9">Sep</option>
                  <option value="10">Oct</option>
                  <option value="11">Nov</option>
                  <option value="12">Dic</option>
                </select>
                
                <select id="filter_evento_a√±o" name="filter_evento_a√±o" class="text-xs border border-gray-200 rounded-md px-2 py-1 bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-200 transition-all appearance-none">
                  <option value="">A√±o</option>
                  <option value="2024">2024</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Lista de eventos (m√°ximo 5) -->
          {% if eventos %}
          <div class="space-y-4">
            {% for evento in eventos[:5] %}
            <div class="border border-gray-200 rounded-2xl p-4 group relative hover:shadow-lg transition-all duration-300 ease-in-out bg-white transform hover:-translate-y-1 hover:border-blue-200" 
                 data-tipo="evento" 
                 data-fecha="{{ evento.fecha.isoformat() }}" 
                 data-proyecto="{{ evento.proyecto.nombre if evento.proyecto else 'Sin proyecto' }}">
              <!-- Men√∫ de 3 puntos para eventos -->
              {% if current_user.rol == 'admin' or current_user.is_admin %}
              <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                <div class="relative dropdown">
                  <button class="dropdown-toggle" data-dropdown-id="evento-{{ evento.id }}" type="button" aria-label="Opciones de evento">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                    </svg>
                  </button>
                  <div id="dropdown-evento-{{ evento.id }}" class="dropdown-menu">
                    <button class="dropdown-item" onclick="abrirModalParticipantes('{{ evento.id }}', '{{ evento.titulo }}')" type="button">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.196-2.121M17 20H7m10 0v-2c0-5.523-3.582-10-8-10s-8 4.477-8 10v2m10 0H7m0 0H2v-2a3 3 0 015.196-2.121M7 20v-2m5-10a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                      Ver participantes
                    </button>
                    <button class="dropdown-item danger" data-delete-url="{{ url_for('home.delete_evento', id=evento.id) }}" data-delete-type="evento" type="button">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>
              {% endif %}
              
              <!-- Fecha destacada -->
              <div class="flex items-start gap-3 mb-3">
                <div class="bg-yellow-400 text-white rounded-xl px-3 py-2 text-center min-w-[60px] flex-shrink-0">
                  <div class="text-lg font-bold">{{ evento.fecha.strftime('%d') }}</div>
                  <div class="text-xs uppercase">{{ evento.fecha.strftime('%b') }}</div>
                </div>
                <div class="flex-1">
                  <h3 class="font-semibold text-gray-900 mb-1 pr-6">{{ evento.titulo }}</h3>
                  <div class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                    <span>{{ evento.fecha.strftime('%d %B %Y') }}</span>
                    {% if evento.hora %}
                    <span>‚Ä¢</span>
                    <span>{{ evento.hora.strftime('%H:%M') }}{% if evento.get_hora_fin() %} - {{ evento.get_hora_fin().strftime('%H:%M') }}{% endif %}</span>
                    {% endif %}
                  </div>
                  <p class="text-sm text-gray-600 leading-relaxed mb-3">{{ evento.descripcion or 'Oficinas EHStandard Monterrey' }}</p>
                </div>
              </div>
              
              <!-- Participantes y acciones -->
              <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                <!-- Avatares de participantes - Dise√±o realista -->
                <div class="flex items-center gap-2">
                  {% set confirmados = evento.participantes.filter_by(estado='confirmado').count() %}
                  {% if confirmados > 0 %}
                    <div class="flex -space-x-2" title="Participantes confirmados">
                      {% for participante in evento.participantes.filter_by(estado='confirmado').limit(3) %}
                        <img class="w-6 h-6 rounded-full border-2 border-white object-cover" 
                             src="{{ participante.user.foto_url or '/static/default_user.png' }}" 
                             alt="{{ participante.user.nombre }}"
                             title="{{ participante.user.nombre }} {{ participante.user.apellido_paterno }}">
                      {% endfor %}
                      {% if confirmados > 3 %}
                        <div class="w-6 h-6 rounded-full border-2 border-white bg-gray-200 flex items-center justify-center text-xs font-medium text-gray-600">
                          +{{ confirmados - 3 }}
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="text-xs text-gray-500 italic">Sin confirmaciones a√∫n</span>
                  {% endif %}
                </div>
                
                <!-- Botones de participaci√≥n inteligentes -->
                <div class="flex items-center gap-2">
                  {% set estado_actual = evento.get_estado_usuario(current_user.id) %}
                  
                  {% if estado_actual != 'confirmado' %}
                  <!-- Bot√≥n confirmar (se muestra si no est√° confirmado) -->
                  <button 
                    class="participar-btn w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out group transform hover:scale-110 hover:shadow-md bg-gray-100 hover:bg-green-100 text-gray-500 hover:text-green-600"
                    title="Confirmar asistencia" 
                    data-evento-id="{{ evento.id }}" 
                    data-accion="confirmado">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  </button>
                  {% endif %}
                  
                  {% if estado_actual != 'declinado' %}
                  <!-- Bot√≥n declinar (se muestra si no est√° declinado) -->
                  <button 
                    class="participar-btn w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out group transform hover:scale-110 hover:shadow-md bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-600"
                    title="No asistir√©" 
                    data-evento-id="{{ evento.id }}" 
                    data-accion="declinado">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                  {% endif %}
                  
                  {% if estado_actual == 'confirmado' %}
                  <!-- Bot√≥n para quitar confirmaci√≥n -->
                  <button 
                    class="participar-btn w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out group transform hover:scale-110 hover:shadow-md bg-green-100 text-green-600"
                    title="Confirmado - Clic para quitar confirmaci√≥n" 
                    data-evento-id="{{ evento.id }}" 
                    data-accion="declinado">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                  {% endif %}
                  
                  {% if estado_actual == 'declinado' %}
                  <!-- Bot√≥n para quitar declinaci√≥n -->
                  <button 
                    class="participar-btn w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out group transform hover:scale-110 hover:shadow-md bg-red-100 text-red-600"
                    title="Declinado - Clic para confirmar asistencia" 
                    data-evento-id="{{ evento.id }}" 
                    data-accion="confirmado">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  </button>
                  {% endif %}
                </div>
                
                <!-- Ver participantes como texto - Solo en m√≥vil -->
                <button class="lg:hidden text-xs text-blue-600 hover:text-blue-800 font-medium" onclick="abrirModalParticipantes({{ evento.id }})">
                  Ver participantes
                </button>
              </div>
              
              {% if evento.link_teams %}
              <div class="mt-2">
                <a href="{{ evento.link_teams }}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 text-xs font-medium transition-colors">
                  üîó Unirse al evento
                </a>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-8">
            <svg class="mx-auto h-10 w-10 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-gray-500 text-sm">No hay eventos pr√≥ximos programados</p>
          </div>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>
</div>
<!-- Modales -->
<!-- Modal para agregar evento -->
{% if current_user.rol == 'admin' or current_user.is_admin %}
<div id="modal-evento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 transition-all p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto p-5 relative">
    <button id="btn-cerrar-modal-evento" type="button" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-xl font-bold focus:outline-none transition-colors">&times;</button>
    
    <div class="mb-5">
      <h3 class="text-lg font-semibold text-gray-900 mb-1">Nuevo evento</h3>
      <p class="text-sm text-gray-600">Crea un evento para el equipo</p>
    </div>
    
    <form id="form-evento" method="POST" action="{{ url_for('home.create_evento') }}" class="space-y-3">
      {{ form_post.csrf_token }}
      
      <!-- T√≠tulo del evento -->
      <div class="space-y-1">
        <label class="block text-sm font-medium text-gray-700">T√≠tulo del evento *</label>
        <input type="text" name="titulo" required placeholder="Ej: Reuni√≥n de equipo, Workshop..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm" />
      </div>
      
      <!-- Fecha, hora y duraci√≥n en grid -->
      <div class="grid grid-cols-3 gap-3">
        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Fecha *</label>
          <input type="date" name="fecha" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm bg-transparent" />
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Hora</label>
          <input type="time" name="hora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm bg-transparent" />
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Duraci√≥n (min)</label>
          <input type="number" name="duracion_minutos" value="60" min="15" max="480" step="15" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm" />
        </div>
      </div>
      
      <!-- Descripci√≥n -->
      <div class="space-y-1">
        <label class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
        <textarea name="descripcion" rows="2" placeholder="Describe de qu√© trata el evento..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm resize-none"></textarea>
      </div>
      
      <!-- Link Teams -->
      <div class="space-y-1">
        <label class="block text-sm font-medium text-gray-700">Enlace de Teams (opcional)</label>
        <input type="url" name="link_teams" placeholder="https://teams.microsoft.com/..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors text-sm" />
      </div>
      
      <!-- Selector de proyectos para el evento -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">Visibilidad del evento</label>
        <div class="relative">
          <div class="flex bg-gray-100 rounded-xl p-1" role="tablist">
            <button type="button" id="tab-event-public" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 bg-white text-blue-600 shadow-sm" data-tab="public" onclick="switchEventVisibilityTab('public')">
              <span class="flex items-center justify-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                P√∫blico
              </span>
            </button>
            <button type="button" id="tab-event-private" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-800" data-tab="private" onclick="switchEventVisibilityTab('private')">
              <span class="flex items-center justify-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                Privado
              </span>
            </button>
          </div>
        </div>
        
        <!-- Selector de proyectos espec√≠ficos para eventos -->
        <div id="event-projects-container" class="hidden transition-all duration-200">
          <div class="p-3 border border-gray-200 rounded-xl bg-gray-50 mt-2">
            <label class="text-xs font-medium text-gray-600 mb-2 block">Proyectos espec√≠ficos:</label>
            <div class="space-y-1 max-h-28 overflow-y-auto custom-scrollbar">
              {% if proyectos %}
              {% for proyecto in proyectos %}
              <label class="flex items-center gap-2 cursor-pointer hover:bg-white p-1.5 rounded-lg transition-colors group">
                <input type="checkbox" name="proyectos_evento" value="{{ proyecto.id }}" class="w-3.5 h-3.5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-1">
                <span class="text-sm text-gray-700 group-hover:text-gray-900">{{ proyecto.nombre }}</span>
              </label>
              {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Botones -->
      <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
        <button type="button" id="btn-cancelar-evento" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">Cancelar</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition-colors">Crear evento</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Modal Nueva Publicaci√≥n -->
<div id="modal-post" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 transition-all p-4" aria-hidden="true">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[85vh] overflow-y-auto p-5 relative">
    <button id="btn-cerrar-modal-post" type="button" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-lg font-bold focus:outline-none transition-colors">&times;</button>
    
    <div class="mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Nueva publicaci√≥n</h3>
    </div>
    
    <form id="post-form-modal" method="POST" action="{{ url_for('home.create_post') }}" enctype="multipart/form-data" class="space-y-4">
      {{ form_post.csrf_token }}
      
      <!-- Selector de visibilidad estilo Apple -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">Visibilidad</label>
        <div class="relative">
          <div class="flex bg-gray-100 rounded-xl p-1" role="tablist">
            <button type="button" id="tab-public" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 bg-white text-blue-600 shadow-sm" data-tab="public" onclick="switchVisibilityTab('public')">
              <span class="flex items-center justify-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                P√∫blico
              </span>
            </button>
            <button type="button" id="tab-private" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-800" data-tab="private" onclick="switchVisibilityTab('private')">
              <span class="flex items-center justify-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                Privado
              </span>
            </button>
          </div>
        </div>
        
        <!-- Selector de proyectos espec√≠ficos -->
        <div id="projects-container" class="hidden transition-all duration-200">
          <div class="p-3 border border-gray-200 rounded-xl bg-gray-50 mt-2">
            <label class="text-xs font-medium text-gray-600 mb-2 block">Proyectos espec√≠ficos:</label>
            <div class="space-y-1 max-h-28 overflow-y-auto custom-scrollbar">
              {% if proyectos %}
              {% for proyecto in proyectos %}
              <label class="flex items-center gap-2 cursor-pointer hover:bg-white p-1.5 rounded-lg transition-colors group">
                <input type="checkbox" name="proyectos_visibles" value="{{ proyecto.id }}" class="w-3.5 h-3.5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-1">
                <span class="text-sm text-gray-700 group-hover:text-gray-900">{{ proyecto.nombre }}</span>
              </label>
              {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Campo oculto para manejar la visibilidad p√∫blica -->
        <input type="hidden" name="proyectos_visibles" value="todos" id="public-visibility-input">
        <input type="hidden" name="visibility_type" value="public" id="visibility-type-input">
      </div>
      
      <!-- Contenido de la publicaci√≥n -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">Contenido</label>
        <textarea name="content" rows="3" required placeholder="¬øQu√© quieres compartir?" class="w-full px-3 py-2.5 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500 text-sm placeholder-gray-400"></textarea>
      </div>
      
      <!-- Subir imagen compacta -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">Imagen</label>
        
        <div class="relative">
          <input type="file" name="image" id="post-image" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
          <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer">
            <div id="upload-placeholder">
              <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <p class="text-xs text-gray-600">
                <span class="font-medium text-blue-600">Seleccionar imagen</span>
              </p>
            </div>
          </div>
        </div>
        
        <!-- Preview de imagen -->
        <div id="preview-container" class="hidden">
          <div class="relative inline-block">
            <img id="preview-image" src="" alt="Vista previa" class="max-h-32 rounded-xl shadow-sm border border-gray-200 object-contain">
            <button type="button" id="remove-image" class="absolute -top-1 -right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold transition-colors">√ó</button>
          </div>
        </div>
      </div>
      
      <!-- Botones -->
      <div class="flex justify-end gap-2 pt-3 border-t border-gray-100">
        <button type="button" id="btn-cancelar-post" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors text-sm">Cancelar</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2 rounded-xl transition-colors text-sm">Publicar</button>
      </div>
    </form>
  </div>
</div>

<!-- Fin Modales -->

<!-- Modal de Participantes -->
<div id="modal-participantes" class="fixed inset-0 z-50 hidden flex items-center justify-center transition-all p-4" style="backdrop-filter: blur(8px); background: rgba(0, 0, 0, 0.5);">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[85vh] overflow-y-auto p-6 relative transform transition-all duration-300 scale-95" id="modal-participantes-content">
    <button id="btn-cerrar-modal-participantes" type="button" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-lg font-bold focus:outline-none transition-colors">&times;</button>
    
    <div class="mb-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-1" id="titulo-evento-participantes">Participantes del evento</h3>
      <p class="text-sm text-gray-600">Lista de confirmados y pendientes</p>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-3 gap-4 mb-6 p-4 bg-blue-50 rounded-xl">
      <div class="text-center">
        <div class="text-2xl font-bold text-blue-600" data-stat="confirmados">5</div>
        <div class="text-xs text-blue-800 font-medium">Confirmados</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-red-600" data-stat="declinados">2</div>
        <div class="text-xs text-red-800 font-medium">No asisten</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-gray-600" data-stat="pendientes">3</div>
        <div class="text-xs text-gray-800 font-medium">Pendientes</div>
      </div>
    </div>
    
    <!-- Lista de participantes -->
    <div class="space-y-3">
      <h4 class="font-medium text-gray-900 text-sm">Participantes:</h4>
      
      <div id="lista-participantes" class="space-y-2">
        <!-- Los participantes se cargar√°n din√°micamente aqu√≠ -->
        <div class="text-center py-4 text-gray-500 text-sm">
          Cargando participantes...
        </div>
      </div>
    </div>
    
    <!-- Bot√≥n cerrar -->
    <div class="flex justify-end pt-4 border-t border-gray-100 mt-6">
      <button type="button" onclick="cerrarModalParticipantes()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors text-sm">Cerrar</button>
    </div>
  </div>
</div>

{% block scripts %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="{{ url_for('home.static', filename='js/home_clean.js') }}"></script>
<script>
// Funci√≥n para cambiar tabs de visibilidad estilo Apple
function switchVisibilityTab(type) {
  const tabPublic = document.getElementById('tab-public');
  const tabPrivate = document.getElementById('tab-private');
  const projectsContainer = document.getElementById('projects-container');
  const publicInput = document.getElementById('public-visibility-input');
  const visibilityTypeInput = document.getElementById('visibility-type-input');
  
  if (type === 'public') {
    // Activar tab p√∫blico
    tabPublic.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
    tabPublic.classList.remove('text-gray-600', 'hover:text-gray-800');
    tabPrivate.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
    tabPrivate.classList.add('text-gray-600', 'hover:text-gray-800');
    
    // Ocultar selector de proyectos
    projectsContainer.classList.add('hidden');
    publicInput.disabled = false;
    visibilityTypeInput.value = 'public';
    
    // Limpiar selecciones de proyectos
    document.querySelectorAll('input[name="proyectos_visibles"]:not(#public-visibility-input)').forEach(cb => {
      cb.checked = false;
    });
  } else {
    // Activar tab privado
    tabPrivate.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
    tabPrivate.classList.remove('text-gray-600', 'hover:text-gray-800');
    tabPublic.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
    tabPublic.classList.add('text-gray-600', 'hover:text-gray-800');
    
    // Mostrar selector de proyectos
    projectsContainer.classList.remove('hidden');
    publicInput.disabled = true;
    visibilityTypeInput.value = 'private';
  }
}

// Funci√≥n para cambiar tabs de visibilidad de eventos estilo Apple
function switchEventVisibilityTab(type) {
  const tabPublic = document.getElementById('tab-event-public');
  const tabPrivate = document.getElementById('tab-event-private');
  const projectsContainer = document.getElementById('event-projects-container');
  
  if (type === 'public') {
    // Activar tab p√∫blico
    tabPublic.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
    tabPublic.classList.remove('text-gray-600', 'hover:text-gray-800');
    tabPrivate.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
    tabPrivate.classList.add('text-gray-600', 'hover:text-gray-800');
    
    // Ocultar selector de proyectos
    projectsContainer.classList.add('hidden');
    
    // Limpiar selecciones de proyectos
    document.querySelectorAll('input[name="proyectos_evento"]').forEach(cb => {
      cb.checked = false;
    });
  } else {
    // Activar tab privado
    tabPrivate.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
    tabPrivate.classList.remove('text-gray-600', 'hover:text-gray-800');
    tabPublic.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
    tabPublic.classList.add('text-gray-600', 'hover:text-gray-800');
    
    // Mostrar selector de proyectos
    projectsContainer.classList.remove('hidden');
  }
}

// Funci√≥n para manejar participaci√≥n en eventos con actualizaci√≥n autom√°tica
// Funci√≥n mejorada para manejar participaci√≥n
function participarEvento(eventoId, accion) {
  const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
  
  fetch(`/home/evento/${eventoId}/participar`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      ...(csrfToken && { 'X-CSRFToken': csrfToken })
    },
    body: JSON.stringify({ accion: accion })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      // Actualizar inmediatamente la p√°gina para reflejar los cambios
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Error al actualizar participaci√≥n', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Error de conexi√≥n', 'error');
  });
}

// Delegaci√≥n de eventos para botones de participaci√≥n
document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(e) {
    if (e.target.closest('.participar-btn')) {
      e.preventDefault();
      const btn = e.target.closest('.participar-btn');
      const eventoId = btn.dataset.eventoId;
      const accion = btn.dataset.accion;
      
      if (eventoId && accion) {
        participarEvento(eventoId, accion);
      }
    }
  });
});
document.addEventListener('DOMContentLoaded', function() {
  // Manejar botones de participaci√≥n con delegaci√≥n de eventos
  document.addEventListener('click', function(e) {
    if (e.target.closest('.participar-btn')) {
      e.preventDefault();
      const btn = e.target.closest('.participar-btn');
      const eventoId = btn.dataset.eventoId;
      const accion = btn.dataset.accion;
      
      if (eventoId && accion) {
        participarEvento(eventoId, accion);
      }
    }
  });
  
  // Filtros din√°micos para publicaciones
  const filterYear = document.getElementById('filter_year');
  const filterMonth = document.getElementById('filter_month');
  const filterUser = document.getElementById('filter_user');
  
  if (filterYear && filterMonth && filterUser) {
    [filterYear, filterMonth, filterUser].forEach(select => {
      select.addEventListener('change', function() {
        // Construir URL con par√°metros
        const url = new URL(window.location.href);
        url.searchParams.set('filter_year', filterYear.value);
        url.searchParams.set('filter_month', filterMonth.value);
        url.searchParams.set('filter_user', filterUser.value);
        
        // Redirigir con filtros aplicados
        window.location.href = url.toString();
      });
    });
  }
  
  // Filtros din√°micos para eventos
  const filterEventoMes = document.getElementById('filter_evento_mes');
  const filterEventoA√±o = document.getElementById('filter_evento_a√±o');
  
  if (filterEventoMes && filterEventoA√±o) {
    [filterEventoMes, filterEventoA√±o].forEach(select => {
      select.addEventListener('change', function() {
        // Construir URL con par√°metros
        const url = new URL(window.location.href);
        url.searchParams.set('filter_evento_mes', filterEventoMes.value);
        url.searchParams.set('filter_evento_a√±o', filterEventoA√±o.value);
        
        // Redirigir con filtros aplicados
        window.location.href = url.toString();
      });
    });
  }
});

// Funci√≥n para mostrar notificaciones toast
function showToast(message, type = 'info') {
  // Crear elemento toast
  const toast = document.createElement('div');
  toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform ${
    type === 'success' ? 'bg-green-500 text-white' : 
    type === 'error' ? 'bg-red-500 text-white' : 
    'bg-blue-500 text-white'
  }`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  // Animaci√≥n de entrada
  setTimeout(() => {
    toast.style.transform = 'translateX(0)';
  }, 100);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Funci√≥n para abrir modal de participantes con datos reales
function abrirModalParticipantes(eventoId, eventoTitulo) {
  fetch(`/home/evento/${eventoId}/participantes`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const modal = document.getElementById('modal-participantes');
        const modalContent = document.getElementById('modal-participantes-content');
        const titulo = document.getElementById('titulo-evento-participantes');
        const listaParticipantes = document.getElementById('lista-participantes');
        
        if (modal && titulo && listaParticipantes) {
          titulo.textContent = `Participantes: ${data.titulo}`;
          
          // Actualizar estad√≠sticas
          document.querySelector('[data-stat="confirmados"]').textContent = data.estadisticas.confirmados;
          document.querySelector('[data-stat="declinados"]').textContent = data.estadisticas.declinados;
          document.querySelector('[data-stat="pendientes"]').textContent = data.estadisticas.pendientes;
          
          // Construir lista de participantes reales
          let htmlParticipantes = '';
          
          if (data.participantes && data.participantes.length > 0) {
            data.participantes.forEach(participante => {
              let iconoEstado = '';
              let colorEstado = '';
              
              if (participante.estado === 'confirmado') {
                iconoEstado = '<svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                colorEstado = 'bg-green-100';
              } else if (participante.estado === 'declinado') {
                iconoEstado = '<svg class="w-3 h-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                colorEstado = 'bg-red-100';
              } else {
                iconoEstado = '<svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
                colorEstado = 'bg-gray-100';
              }
              
              htmlParticipantes += `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50">
                  <img class="w-8 h-8 rounded-full object-cover" 
                       src="${participante.foto_url || '/static/default_user.png'}" 
                       alt="${participante.nombre}">
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900">${participante.nombre} ${participante.apellido_paterno || ''}</div>
                    <div class="text-xs text-gray-500">${participante.proyecto || 'Sin proyecto'}</div>
                  </div>
                  <div class="w-6 h-6 rounded-full ${colorEstado} flex items-center justify-center">
                    ${iconoEstado}
                  </div>
                </div>
              `;
            });
          } else {
            htmlParticipantes = '<div class="text-center py-4 text-gray-500 text-sm">No hay participantes a√∫n</div>';
          }
          
          listaParticipantes.innerHTML = htmlParticipantes;
          
          // Mostrar modal con animaci√≥n
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          setTimeout(() => {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
          }, 10);
          document.body.classList.add('overflow-hidden');
        }
      } else {
        showToast(data.message || 'Error al cargar participantes', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('Error de conexi√≥n', 'error');
    });
}

// Funci√≥n para cerrar modal de participantes
function cerrarModalParticipantes() {
  const modal = document.getElementById('modal-participantes');
  const modalContent = document.getElementById('modal-participantes-content');
  
  if (modal && modalContent) {
    modalContent.classList.remove('scale-100');
    modalContent.classList.add('scale-95');
    
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
    }, 200);
  }
}

// Funci√≥n para manejar el preview de imagen
function setupImagePreview() {
  const imageInput = document.getElementById('post-image');
  const uploadArea = document.getElementById('upload-area');
  const uploadPlaceholder = document.getElementById('upload-placeholder');
  const previewContainer = document.getElementById('preview-container');
  const previewImage = document.getElementById('preview-image');
  const removeButton = document.getElementById('remove-image');
  
  if (!imageInput || !uploadArea || !previewContainer) return;
  
  // Manejar cambio de archivo
  imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) { // 10MB
        alert('El archivo es demasiado grande. M√°ximo 10MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        uploadArea.classList.add('hidden');
        previewContainer.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });
  
  // Bot√≥n para quitar imagen
  removeButton.addEventListener('click', function() {
    imageInput.value = '';
    previewImage.src = '';
    uploadArea.classList.remove('hidden');
    previewContainer.classList.add('hidden');
  });
  
  // Drag and drop
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('border-blue-400', 'bg-blue-50');
  });
  
  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
  });
  
  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      imageInput.files = files;
      imageInput.dispatchEvent(new Event('change'));
    }
  });
}

// Manejar botones de cancelar
function setupCancelButtons() {
  const cancelPostBtn = document.getElementById('btn-cancelar-post');
  const cancelEventBtn = document.getElementById('btn-cancelar-evento');
  const closePostBtn = document.getElementById('btn-cerrar-modal-post');
  const closeEventBtn = document.getElementById('btn-cerrar-modal-evento');
  const closeParticipantesBtn = document.getElementById('btn-cerrar-modal-participantes');
  
  [cancelPostBtn, closePostBtn].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', () => {
        document.getElementById('modal-post').classList.add('hidden');
        // Limpiar formulario
        document.getElementById('post-form-modal').reset();
        document.getElementById('upload-area').classList.remove('hidden');
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('projects-container').classList.add('hidden');
        // Resetear tabs
        switchVisibilityTab('public');
      });
    }
  });
  
  [cancelEventBtn, closeEventBtn].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', () => {
        document.getElementById('modal-evento').classList.add('hidden');
        document.getElementById('form-evento').reset();
      });
    }
  });
  
  if (closeParticipantesBtn) {
    closeParticipantesBtn.addEventListener('click', cerrarModalParticipantes);
  }
}

// Funciones para filtros din√°micos
function setupFilters() {
  const filterBtns = document.querySelectorAll('[data-filter]');
  const publicaciones = document.querySelectorAll('[data-tipo="publicacion"]');
  const eventos = document.querySelectorAll('[data-tipo="evento"]');
  
  filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const filter = this.getAttribute('data-filter');
      
      // Actualizar estilos de botones
      filterBtns.forEach(b => {
        b.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-200');
        b.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
      });
      
      this.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
      this.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
      
      // Filtrar contenido
      if (filter === 'todo') {
        publicaciones.forEach(p => p.style.display = 'block');
        eventos.forEach(e => e.style.display = 'block');
      } else if (filter === 'publicaciones') {
        publicaciones.forEach(p => p.style.display = 'block');
        eventos.forEach(e => e.style.display = 'none');
      } else if (filter === 'eventos') {
        publicaciones.forEach(p => p.style.display = 'none');
        eventos.forEach(e => e.style.display = 'block');
      } else if (filter === 'proyecto') {
        // Filtrar por proyecto espec√≠fico
        const proyecto = this.getAttribute('data-proyecto');
        publicaciones.forEach(p => {
          const pProyecto = p.getAttribute('data-proyecto');
          p.style.display = (pProyecto === proyecto) ? 'block' : 'none';
        });
        eventos.forEach(e => e.style.display = 'none');
      }
    });
  });
}

// Funci√≥n para filtro por fecha
function setupDateFilter() {
  const dateFilter = document.getElementById('date-filter');
  if (!dateFilter) return;
  
  dateFilter.addEventListener('change', function() {
    const selectedDate = this.value;
    const allItems = document.querySelectorAll('[data-fecha]');
    
    if (!selectedDate) {
      allItems.forEach(item => item.style.display = 'block');
      return;
    }
    
    allItems.forEach(item => {
      const itemDate = item.getAttribute('data-fecha');
      const itemDateObj = new Date(itemDate);
      const selectedDateObj = new Date(selectedDate);
      
      // Comparar solo la fecha (sin hora)
      const itemDateString = itemDateObj.toISOString().split('T')[0];
      const selectedDateString = selectedDateObj.toISOString().split('T')[0];
      
      item.style.display = (itemDateString === selectedDateString) ? 'block' : 'none';
    });
  });
}

// Funci√≥n para b√∫squeda en tiempo real
function setupSearchFilter() {
  const searchInput = document.getElementById('search-filter');
  if (!searchInput) return;
  
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    const allItems = document.querySelectorAll('[data-tipo]');
    
    if (!searchTerm) {
      allItems.forEach(item => item.style.display = 'block');
      return;
    }
    
    allItems.forEach(item => {
      const title = item.querySelector('h3, h4')?.textContent.toLowerCase() || '';
      const content = item.querySelector('p')?.textContent.toLowerCase() || '';
      const author = item.querySelector('[data-author]')?.textContent.toLowerCase() || '';
      
      const matches = title.includes(searchTerm) || 
                     content.includes(searchTerm) || 
                     author.includes(searchTerm);
      
      item.style.display = matches ? 'block' : 'none';
    });
  });
}

// Funci√≥n para limpiar filtros
function clearAllFilters() {
  // Limpiar b√∫squeda
  const searchInput = document.getElementById('search-filter');
  if (searchInput) searchInput.value = '';
  
  // Limpiar fecha
  const dateFilter = document.getElementById('date-filter');
  if (dateFilter) dateFilter.value = '';
  
  // Resetear filtros a "Todo"
  const filterBtns = document.querySelectorAll('[data-filter]');
  filterBtns.forEach(btn => {
    btn.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-200');
    btn.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
  });
  
  const todoBtn = document.querySelector('[data-filter="todo"]');
  if (todoBtn) {
    todoBtn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
    todoBtn.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
  }
  
  // Mostrar todos los elementos
  const allItems = document.querySelectorAll('[data-tipo]');
  allItems.forEach(item => item.style.display = 'block');
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
  console.log('HOME.HTML CARGADO - Todo funcionando correctamente');
  setupImagePreview();
  setupCancelButtons();
  setupFilters();
  setupDateFilter();
  setupSearchFilter();
  
  // Configurar cierre de modal de participantes con ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modalParticipantes = document.getElementById('modal-participantes');
      if (modalParticipantes && !modalParticipantes.classList.contains('hidden')) {
        cerrarModalParticipantes();
      }
    }
  });
  
  // Cerrar modal de participantes al hacer clic fuera
  const modalParticipantes = document.getElementById('modal-participantes');
  if (modalParticipantes) {
    modalParticipantes.addEventListener('click', function(e) {
      if (e.target === this) {
        cerrarModalParticipantes();
      }
    });
  }
});
</script>
<style>
  .font-sfpro {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-feature-settings: 'liga', 'kern';
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Smooth scrolling for mobile events */
  .overflow-x-auto {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .overflow-x-auto::-webkit-scrollbar {
    display: none;
  }
  
  /* Custom scrollbar para el selector de proyectos */
  .custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f7fafc;
  }
  
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 3px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
  }
  
  /* Men√∫ dropdown de 3 puntos */
  .dropdown-menu {
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 120px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    border: 1px solid #e5e7eb;
  }
  
  .dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    color: #374151;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.15s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
  }
  
  .dropdown-item:hover {
    background-color: #f3f4f6;
  }
  
  .dropdown-item.danger {
    color: #6b7280; /* Color gris normal por defecto - igual que la imagen */
    font-weight: 500;
  }
  
  .dropdown-item.danger:hover {
    background-color: #fef2f2;
    color: #dc2626; /* Solo se pone rojo en hover */
  }
  
  .dropdown-item.danger svg {
    color: #6b7280; /* √çcono gris por defecto */
    transition: color 0.15s ease;
  }
  
  .dropdown-item.danger:hover svg {
    color: #dc2626; /* √çcono rojo solo en hover */
  }
  
  .dropdown-toggle {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    color: #6b7280;
    transition: all 0.15s ease;
  }
  
  .dropdown-toggle:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  
  /* Estilos para el √°rea de upload mejorada */
  #upload-area {
    transition: all 0.2s ease;
  }
  
  #upload-area:hover {
    border-color: #3b82f6;
    background-color: #eff6ff;
  }
  
  /* Animaciones para los modales */
  #modal-post, #modal-evento {
    backdrop-filter: blur(4px);
  }
  
  /* Mejoras para los selects */
  select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  
  /* Estilo para labels mejoradas */
  label {
    font-weight: 500;
    color: #374151;
  }
  
  /* Hover effects para cards */
  .hover\:shadow-sm:hover {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }
</style>
{% endblock %}
{% endblock %}